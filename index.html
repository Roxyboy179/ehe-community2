<!DOCTYPE html>

<html lang="de">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>

<meta name="author" content="EHE Community Webseite Studio">
<meta name="description" content="Offizielle Beta-Plattform der EHE Community – entwickelt von EHE Community Webseite Studio. Aktuelle Version: 23.7.29">
<meta name="theme-color" content="#667eea">

<title>EHE Community Web - Beta</title>
<link href="favicon.png" rel="icon" type="image/png"/>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #667eea;
            --primary-dark: #5a67d8;
            --secondary-color: #764ba2;
            --accent-color: #f093fb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --bg-primary: #ffffff;
            --bg-secondary: #f7fafc;
            --border-color: #e2e8f0;
            --shadow: 0 10px 25px rgba(0,0,0,0.1);
            --shadow-lg: 0 20px 40px rgba(0,0,0,0.15);
        }

        [data-theme="dark"] {
            --text-primary: #f7fafc;
            --text-secondary: #e2e8f0;
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --border-color: #4a5568;
            --shadow: 0 10px 25px rgba(0,0,0,0.3);
            --shadow-lg: 0 20px 40px rgba(0,0,0,0.4);
            /* KEIN Hintergrund im Dark Mode, um den Verlauf beizubehalten */
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--text-primary);
            min-height: 100vh;
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        #particlesCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-dots {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
        }

        .dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite both;
        }

        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }

        .loading-text {
            color: white;
            text-align: center;
            font-size: 18px;
            font-weight: 500;
            line-height: 1.6;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 15px 0;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-links {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-link {
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            transition: color 0.3s ease;
            cursor: pointer;
        }

        .nav-link:hover {
            color: var(--primary-color);
        }

        .auth-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .main-content {
            margin-top: 80px;
            min-height: calc(100vh - 80px);
        }

        .hero {
            text-align: center;
            padding: 100px 20px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            margin: 20px;
            border-radius: 20px;
            color: white;
        }

        .hero h1 {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #fff, rgba(255,255,255,0.8));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        .content-section {
            max-width: 1200px;
            margin: 0 auto;
            padding: 60px 20px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 60px;
        }

        .feature-card {
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .contact-section {
            background: rgba(255,255,255,0.95);
            padding: 40px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            text-align: center;
            margin: 20px;
        }

        .contact-email {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin: 20px 0;
            font-weight: 600;
        }

        .form-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .form-container {
            background: var(--bg-primary);
            padding: 40px;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 400px;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        .form-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .form-close:hover {
            color: var(--error-color);
        }

        .form-title {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-submit {
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .form-submit:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .form-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .form-link {
            text-align: center;
            margin-top: 20px;
            color: var(--text-secondary);
        }

        .form-link a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .form-link a:hover {
            text-decoration: underline;
        }

        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 3000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            box-shadow: var(--shadow);
        }

        .notification {
            transform: translateX(400px);
            visibility: hidden;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease, visibility 0s linear 0.3s;
        }

        .notification.show {
            transform: translateX(0);
            visibility: visible;
            opacity: 1;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .notification.success { background: var(--success-color); }
        .notification.error { background: var(--error-color); }
        .notification.warning { background: var(--warning-color); }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 25px;
            background: rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .user-profile:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2500;
            animation: fadeIn 0.5s ease;
        }

        .welcome-box {
            background: var(--bg-primary);
            padding: 40px;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            text-align: center;
            max-width: 400px;
            width: 90%;
            position: relative;
            animation: slideIn 0.5s ease;
        }

        .welcome-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .welcome-box h2 {
            margin-bottom: 20px;
            color: var(--text-primary);
            font-size: 24px;
        }

        .welcome-box p {
            margin-bottom: 30px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-primary);
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 10px;
            min-width: 150px;
            z-index: 1000;
            margin-top: 5px;
        }

        .dropdown-item {
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.3s ease;
            color: var(--text-primary);
        }

        .dropdown-item:hover {
            background: var(--bg-secondary);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .hero h1 {
                font-size: 2.5rem;
            }
            
            .hero p {
                font-size: 1rem;
            }
            
            .features-grid {
                grid-template-columns: 1fr;
            }
        }
    
        .badge-scroll-box {
  max-height: 60vh;
  overflow-y: auto;
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  padding: 10px;
  justify-content: center;
}

.badge {
  background: linear-gradient(135deg, #edf2f7, #e2e8f0);
  border-radius: 14px;
  padding: 12px;
  width: 140px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  text-align: center;
  transition: transform 0.2s ease;
}
.badge:hover {
  transform: translateY(-4px);
}
.badge div {
  margin: 3px 0;
}
.badge .badge-icon {
  font-size: 24px;
}
.badge .badge-title {
  font-weight: 700;
  font-size: 14px;
}
.badge .badge-desc {
  font-size: 12px;
  color: var(--text-secondary);
}

/* Darkmode Support */
[data-theme="dark"] .badge {
  background: linear-gradient(135deg, #2d3748, #1a202c);
  color: #f7fafc;
}
[data-theme="dark"] .badge .badge-desc {
  color: #a0aec0;
}


[data-theme="dark"] .form-container {
    background: #2d3748;
    color: #f7fafc;
}
[data-theme="dark"] .form-input {
    background: #1a202c;
    color: #f7fafc;
    border-color: #4a5568;
}
[data-theme="dark"] .form-label {
    color: #e2e8f0;
}
[data-theme="dark"] .form-close {
    color: #e2e8f0;
}

#themeToggle {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--bg-primary);
    color: var(--text-primary);
    border: 2px solid var(--border-color);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 20px;
    box-shadow: var(--shadow);
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 5000;
}
#themeToggle:hover {
    background: var(--primary-color);
    color: white;
}
[data-theme="dark"] #themeToggle {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border-color: var(--border-color);
}

[data-theme="dark"] .feature-card,
[data-theme="dark"] .contact-section,
[data-theme="dark"] .hero,
[data-theme="dark"] .form-container,
[data-theme="dark"] .welcome-box {
    background: #2d3748 !important;
    color: #f7fafc !important;
}

[data-theme="dark"] .hero h1,
[data-theme="dark"] .feature-card h3,
[data-theme="dark"] .contact-section h2,
[data-theme="dark"] .form-title {
    color: #f7fafc !important;
}

[data-theme="dark"] .hero p,
[data-theme="dark"] .feature-card p,
[data-theme="dark"] .contact-section .contact-email,
[data-theme="dark"] .form-label {
    color: #e2e8f0 !important;
}

[data-theme="dark"] body {
    background: #1a202c !important;
}

[data-theme="dark"] .header {
    background: rgba(26, 32, 44, 0.95) !important;
    box-shadow: var(--shadow-lg) !important;
}

[data-theme="dark"] .nav-link {
    color: #e2e8f0 !important;
}

[data-theme="dark"] .nav-link:hover {
    color: var(--accent-color) !important;
}

[data-theme="dark"] .logo {
    -webkit-text-fill-color: #f7fafc !important;
}

#helpCenterButton {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: var(--bg-primary);
    color: var(--text-primary);
    border: 2px solid var(--border-color);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 22px;
    font-weight: bold;
    box-shadow: var(--shadow);
    text-align: center;
    line-height: 46px;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 5000;
}
#helpCenterButton:hover {
    background: var(--primary-color);
    color: white;
}
[data-theme="dark"] #helpCenterButton {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border-color: var(--border-color);
}

.hamburger {
  display: none;
  font-size: 28px;
  cursor: pointer;
}
.mobile-nav {
  display: none;
  flex-direction: column;
  background: var(--bg-primary);
  position: absolute;
  top: 60px;
  right: 20px;
  z-index: 1100;
  box-shadow: var(--shadow-lg);
  border-radius: 10px;
}
.mobile-nav .nav-link {
  padding: 15px;
  text-align: center;
}
@media (max-width: 768px) {
  .hamburger {
    display: block;
  }
}

/* Discord-ähnlicher Verwarnungspopup */
#warningOverlay .welcome-box {
  max-width: 420px;
  background: var(--bg-primary);
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 12px 28px rgba(0,0,0,0.3);
  color: var(--text-primary);
  text-align: left;
}

#warningOverlay .welcome-box h2 {
  font-size: 20px;
  margin-bottom: 10px;
  color: var(--error-color);
}

#warningOverlay .welcome-box p,
#warningOverlay .welcome-box small {
  font-size: 15px;
  color: var(--text-secondary);
}


/* Glänzender Effekt bei Hover für .btn-primary */
.btn-primary {
  position: relative;
  overflow: hidden;
}
.btn-primary::after {
  content: "";
  position: absolute;
  top: 0;
  left: -75%;
  width: 50%;
  height: 100%;
  background: linear-gradient(120deg, rgba(255,255,255,0.2), rgba(255,255,255,0.6), rgba(255,255,255,0.2));
  transform: skewX(-20deg);
  transition: left 0.5s;
}
.btn-primary:hover::after {
  left: 125%;
}


/* Feature-Karten mit weicher Transformation und Licht-Glow beim Hover */
.feature-card {
  transition: transform 0.4s ease, box-shadow 0.4s ease;
}
.feature-card:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
}


.feature-card {
  position: relative;
  overflow: hidden;
  transition: transform 0.4s ease, box-shadow 0.4s ease;
}
.feature-card:hover {
  transform: translateY(-8px) scale(1.03);
  box-shadow: 0 12px 30px rgba(102, 126, 234, 0.5);
}

.feature-card::after {
  content: "";
  position: absolute;
  top: 0;
  left: -75%;
  width: 50%;
  height: 100%;
  background: linear-gradient(120deg, rgba(255,255,255,0.15), rgba(255,255,255,0.4), rgba(255,255,255,0.15));
  transform: skewX(-20deg);
  transition: left 0.75s;
}
.feature-card:hover::after {
  left: 125%;
}

#maintenanceOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(10, 10, 10, 0.95);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 999999;
  animation: fadeIn 1s ease forwards;
  color: white;
}

.maintenance-box {
  text-align: center;
  background: #1a202c;
  padding: 40px;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
  animation: scaleIn 0.6s ease;
  max-width: 90%;
  width: 400px;
}

.maintenance-box h2 {
  font-size: 24px;
  margin-bottom: 15px;
  color: #f59e0b;
}

.maintenance-box p {
  font-size: 15px;
  margin-bottom: 15px;
  color: #e2e8f0;
  line-height: 1.5;
}

#countdownTimer {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 20px;
  color: #10b981;
}

.maintenance-box a {
  color: #63b3ed;
  text-decoration: underline;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes scaleIn {
  from { transform: scale(0.85); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}



.version-label {
    display: inline-block;
    margin-left: 10px;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    opacity: 0.8;
    vertical-align: middle;
}
[data-theme="dark"] .version-label {
    color: #e2e8f0;
    opacity: 0.7;
}

</style>
<link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet"/>

<style>
@keyframes blink {
  0% { opacity: 1; }
  50% { opacity: 0.3; }
  100% { opacity: 1; }
}
.blinking-warning {
  animation: blink 1s infinite;
  color: var(--error-color);
  font-weight: bold;
}
</style>

</head>
<body>
<canvas id="particlesCanvas"></canvas>
<div class="welcome-overlay" id="welcomeOverlay" style="display: none;">
<div class="welcome-box">
<button class="welcome-close" onclick="closeWelcome()">×</button>
<h2>👋 Willkommen bei der EHE Community!</h2>
<p>Tritt unserem Discord bei und sei Teil unserer wachsenden Community.</p>
<a class="btn btn-primary" href="https://discord.gg/hnpV5QwFZR" target="_blank">Zum Discord</a>
</div>
</div>
<div class="loading-screen" id="loadingScreen">
<div class="loading-spinner"></div>
<div class="loading-dots">
<div class="dot"></div><div class="dot"></div><div class="dot"></div>
</div>
<div class="loading-text">
        Willkommen bei EHE Community Web<br/>Gemeinsam. Stark. Vernetzt
    </div>
</div>
<header class="header">
<div class="nav-container">
<div class="logo" style="font-family: Poppins, sans-serif; font-size: 28px;"><span style="color: var(--primary-color)">EHE</span><span style="color: var(--secondary-color)"> Community Beta</span></div>
<nav class="nav-links">
<a class="nav-link" href="#">Home</a>
<a class="nav-link" href="#">Community</a>
<a class="nav-link" href="#">Events</a>
<a class="nav-link" href="#">Kontakt</a>
</nav>
<div class="auth-buttons" id="authButtons">
<button class="btn btn-secondary" onclick="showLoginForm()">Anmelden</button>
<button class="btn btn-primary" onclick="showRegisterForm()">Registrieren</button>
<div class="version-label">v23.7.29</div>
</div>
<div class="user-profile" id="userProfile" style="display: none;">
<button id="activityButton" style="background: transparent; border: none; font-size: 20px; cursor: pointer;" title="Aktivitätsübersicht">📊</button>
<div class="user-avatar" id="userAvatar" style="display: flex;">U</div>
<span id="userName">User</span>
<div style="font-size: 12px; color: var(--text-secondary);">
  Level: <strong id="userLevel">1</strong> · XP: <strong id="userXP">0 / 100</strong><br>
  🏅 Rang: <strong id="userBadge">🟢 Neuling</strong>
</div>


<div class="user-dropdown" id="userDropdown" style="display: none;"><div class="dropdown-item" onclick="showSecurityStatus()">🛡️ Sicherheitsstatus</div>
<div class="dropdown-item" onclick="showXPLog()">📜 XP-Log anzeigen</div>
<div class="dropdown-item" onclick="showBadgePopup()">🎖 Aktuelle Badges</div>

<div class="dropdown-item" onclick="showChangePasswordFormWithPassword()">Passwort ändern</div><div class="dropdown-item" onclick="showEditProfileFormWithPassword()">Profil bearbeiten</div>
<div class="dropdown-item" onclick="showWarnings()">⚠️ Verwarnungen</div><div class="dropdown-item" onclick="logout()">Logout</div></div></div>
<div class="hamburger" id="hamburger">☰</div>
<div class="mobile-nav" id="mobileNav">
<a class="nav-link" href="#">Home</a>
<a class="nav-link" href="#">Community</a>
<a class="nav-link" href="#">Events</a>
<a class="nav-link" href="#">Kontakt</a>
</div>
</div>
</header>
<main class="main-content" id="mainContent">
<section class="hero">
<h1>Willkommen in der EHE Community</h1>
<p>Gemeinsam stark, vernetzt und erfolgreich - Deine Community wartet auf dich!</p>
<small style="display:block; margin-top:20px; font-style: italic;">Entwickelt von <strong>EHE Community Webseite Studio</strong></small>
</section>
<div class="content-section" id="features-start">
<div class="features-grid">
<div class="feature-card" data-aos="fade-up" data-aos-delay="0" onclick="handleCommunityChat()" style="cursor: pointer;">
<div class="feature-icon">💬</div>
<h3>Community Chat</h3>
<p>Trete unserem Discord bei und chatte mit anderen Community-Mitgliedern in Echtzeit.</p>
</div>
<div class="feature-card" data-aos="fade-up" data-aos-delay="100" onclick="handleGamingEvents()" style="cursor: pointer;">
<div class="feature-icon">🎮</div>
<h3>Gaming Events</h3>
<p>Nimm an regelmäßigen Gaming-Events teil und erlebe spannende Wettkämpfe.</p>
</div>
<div class="feature-card" data-aos="fade-up" data-aos-delay="200" onclick="handleAchievements()" style="cursor: pointer;">
<div class="feature-icon">🏆</div>
<h3>Achievements</h3>
<p>Sammle Achievements und zeige deine Erfolge der Community.</p>
</div>
<div class="feature-card" data-aos="fade-up" data-aos-delay="300" onclick="showUpdatesSequence()" style="cursor: pointer;">
<div class="feature-icon">📰</div>
<h3>Updates</h3>
<p>Entdeckte die Neuen Updates mit einem Klick - Derzeit in Wartungsarbeiten</p>
</div>
<div class="feature-card" data-aos="fade-up" data-aos-delay="400" onclick="showDiscordPopup()" style="cursor: pointer;">
  <div class="feature-icon">👋</div>
  <h3>Unser Discord</h3>
  <p>Entdecke unsere Community auf Discord und verknüpfe dich direkt mit uns.</p>
</div>
<div class="feature-card" data-aos="fade-up" data-aos-delay="500" onclick="showFeedbackPopup()" style="cursor: pointer;">
  <div class="feature-icon" onclick="showFeedbackForm()" style="cursor: pointer;">⭐</div>
  <h3>Feedback an uns</h3>
  <p>Hey Hast du bereits Erfahrung bei uns den Gebe uns gerne ein Feedback jede Positive Bewertung Hilfts uns Weiter.</p>
</div>
<div class="feature-card" data-aos="fade-up" data-aos-delay="600" onclick="showSupportzeitenPopup()" style="cursor: pointer;">
  <div class="feature-icon" onclick="showSupportzeitenForm()" style="cursor: pointer;">⌚</div>
  <h3>Unsere Supportzeiten</h3>
  <p>Ihr Finden sie unsere aktuellen Supportzeiten sowie unsere Urlaubstage</p>
</div>
<div class="feature-card" data-aos="fade-up" data-aos-delay="600" onclick="showdashboardPopup()" style="cursor: pointer;">
  <div class="feature-icon" style="cursor: pointer;">📊</div>
  <h3>Zum Dashboard</h3>
  <p>Öffne das neue Dashboard der EHE Community Plattform</p>
</div>
</div>
</div>
<div class="contact-section" id="kontaktbereich">
<h2>Kontakt</h2>
<div class="contact-email">E-Mail: hamburgp20@gmail.com</div>
<button class="btn btn-primary" onclick="showContactForm()">Kontaktformular</button>
</div>
</div>
</main>

<!-- XP-Log Overlay -->
<div class="form-overlay" id="xpLogOverlay" style="display: none;">
  <div class="form-container" style="max-height: 90vh; overflow-y: auto;">
    <button class="form-close" onclick="document.getElementById('xpLogOverlay').style.display='none'">×</button>
    <h2 class="form-title">📜 XP-Verlauf</h2>
    <div id="xpLogEntries" style="margin-top: 20px; max-height: 60vh; overflow-y: auto;">
      <p>Keine XP-Aktivitäten vorhanden.</p>
    </div>
  </div>
</div>

<div class="welcome-overlay" id="dashboardConfirmOverlay" style="display: none;">
  <div class="welcome-box">
    <button class="welcome-close" onclick="closeDashboardPopup()">×</button>
    <h2>🚀 Weiterleitung zum Dashboard</h2>
    <p>Bist du dir wirklich sicher, dass du zum Dashboard der EHE Community weitergeleitet werden möchtest?</p>
    <button id="confirmDashboardBtn" class="btn btn-primary" onclick="confirmDashboardRedirect()">Jetzt zum Dashboard</button>
  </div>
</div>

<!-- Dashboard Weiterleitung -->
<div class="welcome-overlay" id="dashboardConfirmOverlay" style="display: none;">
  <div class="welcome-box">
    <button class="welcome-close" onclick="closeDashboardPopup()">×</button>
    <h2>🚀 Weiterleitung zum Dashboard</h2>
    <p>Bist du dir wirklich sicher, dass du zum Dashboard der EHE Community weitergeleitet werden möchtest?</p>
    <button id="confirmDashboardBtn" class="btn btn-primary" onclick="confirmDashboardRedirect()">Jetzt zum Dashboard</button>
  </div>
</div>

<script>
function showdashboardPopup() {
  document.getElementById('dashboardConfirmOverlay').style.display = 'flex';
}

function closeDashboardPopup() {
  document.getElementById('dashboardConfirmOverlay').style.display = 'none';
}

function confirmDashboardRedirect() {
  const btn = document.getElementById('confirmDashboardBtn');
  btn.disabled = true;
  btn.textContent = 'Sie werden umgeleitet...';
  setTimeout(() => {
    window.location.href = "https://roxyboy179.github.io/ehecommunity_dashboard/";
  }, 5000);
}

function showVerifyEmailOverlay(username, email) {
  document.getElementById('verifyUserName').textContent = username;
  document.getElementById('verifyEmailTarget').textContent = email;
  document.getElementById('verifyEmailOverlay').style.display = 'flex';
}

function closeVerifyEmail() {
  document.getElementById('verifyEmailOverlay').style.display = 'none';
}

// Feedback anzeigen
function showFeedbackForm() {
  if (!currentUser) {
    showNotification("Bitte melde dich an, um Feedback zu geben.", "error");
    return;
  }
  document.getElementById("feedbackOverlay").style.display = "flex";
}
function hideFeedbackForm() {
  document.getElementById("feedbackOverlay").style.display = "none";
}
let selectedStars = 0;
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("#starRating span").forEach(star => {
    star.addEventListener("click", () => {
      selectedStars = parseInt(star.getAttribute("data-stars"));
      document.querySelectorAll("#starRating span").forEach(s => s.classList.remove("selected"));
      for (let i = 0; i < selectedStars; i++) {
        document.querySelectorAll("#starRating span")[i].classList.add("selected");
      }
    });
  });

  document.getElementById("feedbackForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    if (selectedStars === 0) {
      showNotification("Bitte Sterne auswählen", "error");
      return;
    }

    const reason = document.getElementById("feedbackReason").value;
    const text = document.getElementById("feedbackText").value;
    const username = currentUser?.user_metadata?.username || currentUser?.email;

    const webhookURL = "Keine Verbindung Zum Workbock";

    const payload = {
      content: "**📩 Neues Feedback erhalten**",
      embeds: [
        {
          color: 0x5865F2,
          title: "🌟 Feedback",
          fields: [
            { name: "Benutzername", value: username },
            { name: "Sterne Bewertung", value: `${"⭐".repeat(selectedStars)} (${selectedStars}/5)` },
            { name: "Bewertungsgrund", value: reason },
            { name: "Nachricht", value: text || "_Keine Nachricht angegeben_" }
          ],
          timestamp: new Date().toISOString()
        }
      ]
    };

    try {
      await fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      hideFeedbackForm();
      document.getElementById("feedbackForm").reset();
      selectedStars = 0;
      document.querySelectorAll("#starRating span").forEach(s => s.classList.remove("selected"));
      showNotification("Danke für dein Feedback!", "success");
    } catch (error) {
      console.error(error);
      showNotification("Feedback System Offline | 404 |", "error");
    }
  });
});


function showUpdatesSequence() {
  const loading = document.getElementById("updatesLoading");
  loading.style.display = "flex";

  setTimeout(() => {
    loading.style.opacity = "0";
    setTimeout(() => {
      loading.style.display = "none";
      loading.style.opacity = "1";
      document.getElementById("updatesOverlay").style.display = "flex";
    }, 500);
  }, 10000);
}


function showSecurityStatus() {
  if (!currentUser) {
    showNotification("Nicht eingeloggt", "error");
    return;
  }

  document.getElementById("secEmail").textContent = currentUser.email || "-";
  document.getElementById("secEmailConfirmed").textContent = currentUser.email_confirmed_at ? "✅ Ja" : "❌ Nein";

  const createdAt = new Date(currentUser.created_at).toLocaleString('de-DE');
  document.getElementById("secCreatedAt").textContent = createdAt;

  const lastLogin = currentUser.last_sign_in_at
    ? new Date(currentUser.last_sign_in_at).toLocaleString('de-DE')
    : "Unbekannt";
  document.getElementById("secLastLogin").textContent = lastLogin;

  document.getElementById("securityOverlay").style.display = "flex";
}

function hideSecurityStatus() {
  document.getElementById("securityOverlay").style.display = "none";
}

</script>
<!-- Login Form -->
<div class="form-overlay" id="loginOverlay">
<div class="form-container">
<button class="form-close" onclick="hideLoginForm()">×</button>
<h2 class="form-title">Anmelden</h2>
<form id="loginForm"><div id="loginError" style="color: var(--error-color); margin-bottom: 10px; display: none;"></div>
<div class="form-group">
<label class="form-label" for="loginEmail">E-Mail</label>
<input class="form-input" id="loginEmail" required="" type="email"/>
</div>
<div class="form-group">
<label class="form-label" for="loginPassword">Passwort</label>
<input class="form-input" id="loginPassword" required="" type="password"/>
</div>
<button class="form-submit" id="loginSubmit" type="submit">Anmelden</button>

<div style="text-align: center; margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
  <div style="margin-bottom: 10px; font-weight: 600; color: var(--text-secondary);">
    Weitere Anmeldemöglichkeiten
  <br>
  <button class="btn btn-secondary" type="button" style="width: 100%; margin-top: 10px;" onclick="showWarnHinweis()">Weitere Anmeldemöglichkeiten anzeigen</button>

  </div>
  <button class="btn btn-primary" type="button" onclick="loginWithDiscord()" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;">
    <img src="discord-icon.svg" alt="Discord" style="width: 20px; height: 20px;">
    Mit Discord anmelden
  </button>
</div>


</form>
<div class="form-link">
            Noch kein Konto? <a href="#" onclick="switchToRegister()">Registrieren</a>
</div>
</div>
</div>
<!-- Register Form -->
<div class="form-overlay" id="registerOverlay">
<div class="form-container">
<button class="form-close" onclick="hideRegisterForm()">×</button>
<h2 class="form-title">Registrieren</h2>
<form id="registerForm"><div id="registerError" style="color: var(--error-color); margin-bottom: 10px; display: none;"></div>
<div class="form-group">
<label class="form-label" for="registerUsername">Benutzername</label>
<input class="form-input" id="registerUsername" required="" type="text"/>
</div>
<div class="form-group">
<label class="form-label" for="registerEmail">E-Mail</label>
<input class="form-input" id="registerEmail" required="" type="email"/>
</div>
<div class="form-group">
<label class="form-label" for="registerPassword">Passwort</label>
<input class="form-input" id="registerPassword" required="" type="password"/>
<div id="passwordStrengthFeedback" style="margin-top:5px; font-size: 13px;"></div>
</div>
<div class="form-group">
<label class="form-label" for="confirmPassword">Passwort bestätigen</label>
<input class="form-input" id="confirmPassword" required="" type="password"/>
</div>
<button class="form-submit" id="registerSubmit" type="submit">Registrieren</button>
</form>
<div class="form-link">
            Bereits ein Konto? <a href="#" onclick="switchToLogin()">Anmelden</a>
</div>
</div>
</div>
<!-- Contact Form -->
<div class="form-overlay" id="contactOverlay">
<div class="form-container">
<button class="form-close" onclick="hideContactForm()">×</button>
<h2 class="form-title">Kontakt</h2>
<form id="contactForm">
<div class="form-group">
<label class="form-label" for="contactName">Name</label>
<input class="form-input" id="contactName" required="" type="text"/>
</div>
<div class="form-group">
<label class="form-label" for="contactEmail">E-Mail</label>
<input class="form-input" id="contactEmail" required="" type="email"/>
</div>
<div class="form-group">
<label class="form-label" for="contactMessage">Nachricht</label>
<textarea class="form-input" id="contactMessage" required="" rows="5"></textarea>
</div>
<button class="form-submit" type="submit">Nachricht senden</button>
</form>
</div>
</div>
<div class="notification" id="notification"></div>
<script src="https://cdn.jsdelivr.net/npm/tsparticles@2/tsparticles.bundle.min.js"></script>
<script>
function initParticles() {
    tsParticles.load("particlesCanvas", {
        fullScreen: { enable: false },
        particles: {
            number: { value: 80 },
            color: { value: ["#ff7eb3", "#ff758c", "#42a5f5", "#7e57c2"] },
            shape: { type: "circle" },
            opacity: {
                value: 0.6,
                anim: { enable: true, speed: 0.8, opacity_min: 0.3, sync: false }
            },
            size: {
                value: { min: 2, max: 5 },
                anim: { enable: true, speed: 3, size_min: 1, sync: false }
            },
            move: { enable: true, speed: 0.8, direction: "none", random: true, straight: false, outModes: "out" },
            links: {
                enable: true,
                distance: 150,
                color: "#ffffff",
                opacity: 0.3,
                width: 1
            }
        },
        background: {
            color: "transparent"
        }
    });
};

// Fehlende Funktionen

function showNotification(message, type = "success") {
    const notification = document.getElementById("notification");
    if (!notification) return;

    notification.textContent = message;
    notification.className = `notification ${type} show`;

    setTimeout(() => {
        notification.classList.remove("show");
    }, 4000);
}

function showLoginForm() {
    document.getElementById("loginOverlay").style.display = "flex";
}

function hideLoginForm() {
    document.getElementById("loginOverlay").style.display = "none";
}

function showRegisterForm() {
    document.getElementById("registerOverlay").style.display = "flex";
}

function hideRegisterForm() {
    document.getElementById("registerOverlay").style.display = "none";
}

function switchToRegister() {
    hideLoginForm();
    showRegisterForm();
}

function switchToLogin() {
    hideRegisterForm();
    showLoginForm();
}


function showContactForm() {
  const overlay = document.createElement("div");
  overlay.className = "welcome-overlay";
  overlay.innerHTML = `
    <div class="welcome-box">
      <button class="welcome-close" onclick="this.parentElement.parentElement.remove()">×</button>
      <h2>📪 Derzeit nicht aufrufbar</h2>
      <p>Derzeit bieten wir kein Kontaktformular an.<br><br>
      Schreiben Sie uns einfach per E-Mail an:<br>
      <strong>hamburgp20@gmail.com</strong><br><br>
      Oder wenden Sie sich an unseren <strong><a href="https://discord.gg/QjnJJWK8U8" target="_blank" style="color: var(--primary-color); text-decoration: underline;">Discord-Server</a></strong>.</p>
    </div>
  `;
  document.body.appendChild(overlay);
}


function hideContactForm() {
    document.getElementById("contactOverlay").style.display = "none";
}

function showWelcomeOverlay() {
    document.getElementById("welcomeOverlay").style.display = "flex";
}

function closeWelcome() {
    document.getElementById("welcomeOverlay").style.display = "none";
}

function hideAllForms() {
    hideLoginForm();
    hideRegisterForm();
    hideContactForm();
}
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
function hideAllForms() {
    hideLoginForm();
    hideRegisterForm();
    hideContactForm();
}
</script>
<script>
// Zusätzliche Fehleranzeige im Formular
function showLoginError(message) {
    const errorBox = document.getElementById('loginError');
    errorBox.textContent = message;
    errorBox.style.display = 'block';
}
function showRegisterError(message) {
    const errorBox = document.getElementById('registerError');
    errorBox.textContent = message;
    errorBox.style.display = 'block';
}

// Supabase Setup
const { createClient } = supabase;
const supabaseUrl = 'https://avojqdzjszauigitnuiy.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF2b2pxZHpqc3phdWlnaXRudWl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4MTAzNTgsImV4cCI6MjA2NTM4NjM1OH0.1HessC_Wo4D7iIscEZieKBzL0hXteUUq6Dot5oQphvw';
const supabaseClient = createClient(supabaseUrl, supabaseKey, {
  auth: {
    persistSession: true
  }
});


// Global Variables
let currentUser = null;
let currentTheme = 'light';

// DOM Elements
const loadingScreen = document.getElementById('loadingScreen');
const welcomeOverlay = document.getElementById('welcomeOverlay');
const authButtons = document.getElementById('authButtons');
const userProfile = document.getElementById('userProfile');
const loginOverlay = document.getElementById('loginOverlay');
const registerOverlay = document.getElementById('registerOverlay');
const contactOverlay = document.getElementById('contactOverlay');
const notification = document.getElementById('notification');

// Initialize App
document.addEventListener('DOMContentLoaded', async () => {
    try {
        // Loading screen - 3 Sekunden
        setTimeout(() => {
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 500);
        }, 3000);

        // Initialize particles
        initParticles();

        // Load saved theme from session
        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);

        // Check current user session
        
if (!currentUser) {
    setTimeout(() => {
        showWelcomeOverlay();
    }, 3500);
        }

        
// Auto-Login beim Seitenstart prüfen
const autoLoginSetting = localStorage.getItem("autoLogin");
if (autoLoginSetting !== "false") {
  supabaseClient.auth.getSession().then(({ data }) => {
    if (data.session) {
      currentUser = data.session.user;
      updateUIForLoggedInUser();
    }
  });
}

// Auth state listener
        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' && session) {
                currentUser = session.user;
                updateUIForLoggedInUser();
                checkUserSecurity(currentUser);
                hideAllForms();
                showNotification('Erfolgreich angemeldet!', 'success');
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                updateUIForLoggedOutUser();
                showNotification('Erfolgreich abgemeldet!', 'success');
            }
        });

    } catch (error) {
        console.error('Initialisierungsfehler:', error);
        showNotification('Anwendung konnte nicht initialisiert werden', 'error');
    }
});

// Theme Functions
function setTheme(theme) {
    currentTheme = theme;
    if (theme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
    } else {
        document.documentElement.removeAttribute('data-theme');
    }
    localStorage.setItem('theme', theme);
}

// UI Update Functions
function updateUIForLoggedInUser() {
    rewardDailyXP();
    authButtons.style.display = 'none';
    userProfile.style.display = 'flex';

    if (currentUser) {
        const discordName = currentUser.user_metadata?.user_name || currentUser.user_metadata?.full_name;
        const manualName = currentUser.user_metadata?.username;
        const fallbackName = currentUser.email.split('@')[0];

        const userName = discordName || manualName || fallbackName;

        document.getElementById('userName').textContent = userName;
        document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();

        // Buttons abhängig vom Provider anzeigen
        const dropdown = document.getElementById('userDropdown');
        dropdown.innerHTML = '';

        dropdown.innerHTML += `<div class="dropdown-item" onclick="showSecurityStatus()">🛡️ Sicherheitsstatus</div>`;
        dropdown.innerHTML += `<div class="dropdown-item" onclick="showXPLog()">📜 XP-Log anzeigen</div>`;
        dropdown.innerHTML += `<div class="dropdown-item" onclick="showBadgePopup()">🎖 Aktuelle Badges</div>`;

        const provider = sessionStorage.getItem('auth_provider');
        if (provider !== 'discord') {
            dropdown.innerHTML += `<div class="dropdown-item" onclick="showChangePasswordFormWithPassword()">Passwort ändern</div>`;
            dropdown.innerHTML += `<div class="dropdown-item" onclick="showEditProfileFormWithPassword()">Profil bearbeiten</div>`;
        }

        dropdown.innerHTML += `<div class="dropdown-item" onclick="showWarnings()">⚠️ Verwarnungen</div>`;
        dropdown.innerHTML += `<div class="dropdown-item" onclick="logout()">Logout</div>`;
    }
}

function updateUIForLoggedOutUser() {
    authButtons.style.display = 'flex';
    userProfile.style.display = 'none';
}

// === XP via Supabase speichern ===

async function fetchUserXP(userId) {
  const { data, error } = await supabaseClient
    .from('user_xp')
    .select('xp')
    .eq('user_id', userId)
    .single();

  if (error && error.code !== 'PGRST116') {
    console.error('Fehler beim Abrufen von XP:', error);
    return 0;
  }

  return data?.xp || 0;
}

async function saveUserXP(userId, newXP) {
  const { error } = await supabaseClient
    .from('user_xp')
    .upsert({ user_id: userId, xp: newXP }, { onConflict: ['user_id'] });

  if (error) console.error('Fehler beim Speichern von XP:', error);
}

function updateXPUI(xp) {
  const level = Math.floor(xp / 100) + 1;
  const xpInLevel = xp % 100;
  document.getElementById('userXP').textContent = `${xpInLevel} / 100`;
  document.getElementById('userLevel').textContent = level;

  // Badge-Anzeige ab Level 5
  if (level >= 5) {
    document.getElementById('userBadge').textContent = '✨ Selten';
  }
}

async function rewardDailyXP() {
  if (!currentUser) return;
  const today = new Date().toISOString().split('T')[0];
  const lastXPDate = localStorage.getItem('lastXPReward');
  if (lastXPDate === today) return;

  const userId = currentUser.id;
  let currentXP = await fetchUserXP(userId);
  currentXP += 35;
  await saveUserXP(userId, currentXP);
  localStorage.setItem('lastXPReward', today);
  updateXPUI(currentXP);
}


// Auth Functions

function loginWithDiscord() {
    supabaseClient.auth.signInWithOAuth({
        provider: 'discord',
        options: {
            redirectTo: 'https://ehecommunityweb.de'
        }
    });
}



function showBanPopup() {
  document.getElementById("banOverlay").style.display = "flex";
}
function closeBanPopup() {
  document.getElementById("banOverlay").style.display = "none";
}


async function handleLogin(email, password) {
    try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: email,
            password: password
        });

        if (error) throw error;

        return { success: true, data };
    } catch (error) {
        console.error('Login Fehler:', error);

        let userMessage = 'Anmeldung fehlgeschlagen.';

        
if (error?.code === 'user_banned') {
  showBanPopup();
  return { success: false, error: "Dein Konto wurde gesperrt." };
}
 else if (error?.code === 'invalid_login_credentials' || error?.message === 'Invalid login credentials') {
            userMessage = 'E-Mail oder Passwort ist ungültig.';
        } else {
            userMessage = 'Ein unerwarteter Fehler ist mehrmals aufgetreten';
        }

        return { success: false, error: userMessage };
    }
    try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: email,
            password: password
        });

        if (error) throw error;
        
        return { success: true, data };
    } catch (error) {
        console.error('Login Fehler:', error);
        return { success: false, error: error.message };
    };
}

async function handleRegister(email, password, username) {
    try {
        const { data, error } = await supabaseClient.auth.signUp({
            email: email,
            password: password,
            options: {
                data: {
                    username: username
                }
            }
        });

        if (error) throw error;

        return { success: true, data };
    } catch (error) {
        console.error('Registrierung Fehler:', error);
        return { success: false, error: error.message };
    }
}

async function handleLogout() {
    try {
        const { error } = await supabaseClient.auth.signOut();
        if (error) throw error;
        return { success: true };
    } catch (error) {
        console.error('Logout Fehler:', error);
        return { success: false, error: error.message };
    }
}

// Form Event Handlers
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = document.getElementById('loginSubmit');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Anmelden...';
    
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
        showNotification('Bitte alle Felder ausfüllen', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Anmelden';
        return;
    }
    
    const result = await handleLogin(email, password);
    
    if (result.success) {
        hideLoginForm();
        document.getElementById('loginForm').reset();
        showNotification('Willkommen zurück!', 'success');
    } else {
        showNotification(result.error, 'error');
    }

    submitBtn.disabled = false;
    submitBtn.textContent = 'Anmelden';
});


function hideAllForms() {
    hideLoginForm();
    hideRegisterForm();
    hideContactForm();
}

document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = document.getElementById('registerSubmit');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Registrieren...';

    const username = document.getElementById('registerUsername').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    if (!username || !email || !password || !confirmPassword) {
        showNotification('Bitte alle Felder ausfüllen', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Registrieren';
        return;
    }

    if (password !== confirmPassword) {
        showNotification('Passwörter stimmen nicht überein', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Registrieren';
        return;
    }

    const result = await handleRegister(email, password, username);

    if (result.success) {
        hideRegisterForm();
        document.getElementById('registerForm').reset();
        showNotification('Registrierung erfolgreich! Bitte E-Mail bestätigen.', 'success');
        const domain = email.split('@')[1] || 'unbekannt';
        showVerifyEmailOverlay(username, email);
    } else {
        showNotification(result.error, 'error');
    }

    submitBtn.disabled = false;
    submitBtn.textContent = 'Registrieren';
});


function logout() {
    handleLogout().then(() => {
        sessionStorage.clear();
        localStorage.clear();
        showNotification("Abgemeldet", "success");
    });
}



function toggleTheme() {
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    setTheme(newTheme);
    updateThemeToggleButton();
}

function updateThemeToggleButton() {
    const btn = document.getElementById('themeToggle');
    if (btn) {
        btn.textContent = currentTheme === 'dark' ? '☀️' : '🌙';
    }
}

document.addEventListener('DOMContentLoaded', () => {
    updateThemeToggleButton();
});
</script>
<script>
document.getElementById('userProfile').addEventListener('click', function (e) {
    const dropdown = document.getElementById('userDropdown');
    const isVisible = dropdown.style.display === 'block';
    dropdown.style.display = isVisible ? 'none' : 'block';
    e.stopPropagation();
});

document.addEventListener('click', function () {
    const dropdown = document.getElementById('userDropdown');
    if (dropdown) dropdown.style.display = 'none';
});
</script>
<!-- Erweiterung für Profil-System: Profilbild, E-Mail, Statusanzeige + Systemstatus Button -->
<!-- Innerhalb des Edit Profile Forms (editProfileOverlay) -->
<div class="form-overlay" id="editProfileOverlay" style="display: none;">
<div class="form-container">
<button class="form-close" onclick="hideEditProfileForm()">×</button>
<h2 class="form-title">🛠 Profil bearbeiten</h2>
<form id="editProfileForm">
<div class="form-group">
<label class="form-label" for="editUsername">Benutzername</label>
<input class="form-input" id="editUsername" required="" type="text"/>
</div>
<div class="form-group">
<label class="form-label" for="editEmail">E-Mail</label>
<input class="form-input" id="editEmail" required="" type="email"/>
</div>

<div class="form-group">
  <label class="form-label" for="editTheme">
  </label>
</div>
<div class="form-group">
  <label class="form-label" for="editAutoLogin">
    <input type="checkbox" id="editAutoLogin" style="margin-right: 8px;">
    Automatisch anmelden
  </label>
</div>
<div class="form-group">
  <label class="form-label" for="editTheme">Design</label>
  <select class="form-input" id="editTheme">
    <option value="light">Hell</option>
    <option value="dark">Dunkel</option>
  </select>
</div>

<button class="form-submit" type="submit">Profil Speichern</button>
</form>
</div>
</div>
<!-- Avatar-Bild im Profil anzeigen -->
<div class="user-profile" id="userProfile" style="display: none;">
<button id="activityButton" style="background: transparent; border: none; font-size: 20px; cursor: pointer;" title="Aktivitätsübersicht">📊</button>
<div class="user-avatar" id="userAvatar">U</div>
<span id="userName">User</span>
<div class="user-dropdown" id="userDropdown" style="display: none;">
<div class="dropdown-item" onclick="showEditProfileFormWithPassword()">Profil bearbeiten</div>
<div class="dropdown-item" onclick="showWarnings()">⚠️ Verwarnungen</div>
<div class="dropdown-item" onclick="logout()">Logout</div>
</div>
</div>
<button id="themeToggle" onclick="toggleTheme()" title="Darkmode umschalten">🌙</button>
<a href="https://roxyboy179.github.io/ehecommunity_helpcenter/" id="helpCenterButton" target="_blank" title="Zum Helpcenter">❓</a>
<!-- Systemstatus Button unten rechts -->
<a href="https://roxyboy179.github.io/ehecommunity_systemstatus/" id="statusButton" style="position: fixed; bottom: 90px; left: 20px; background: var(--bg-primary); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 50%; width: 50px; height: 50px; font-size: 22px; font-weight: bold; box-shadow: var(--shadow); text-align: center; line-height: 46px; text-decoration: none; cursor: pointer; transition: all 0.3s ease; z-index: 5000;" target="_blank" title="Systemstatus anzeigen">
  🖥️
</a>
<script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
<script>
function toggleTheme() {
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    setTheme(newTheme);
    updateThemeToggleButton();
}

function setTheme(theme) {
    currentTheme = theme;
    document.documentElement.setAttribute('data-theme', theme === 'dark' ? 'dark' : '');
    localStorage.setItem('theme', theme);
    localStorage.setItem('theme', theme);
    document.body.classList.add("theme-transition");
    window.setTimeout(() => document.body.classList.remove("theme-transition"), 500);
}

document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme') || sessionStorage.getItem('theme') || 'light';
    setTheme(savedTheme);
    updateThemeToggleButton();
});
</script><script>
document.getElementById('hamburger').addEventListener('click', function () {
  const nav = document.getElementById('mobileNav');
  nav.style.display = nav.style.display === 'flex' ? 'none' : 'flex';
});
</script><script>
  AOS.init({ duration: 800, once: true });
</script>
<script>
function showEditProfileForm() {
  // Auto-Login Status laden (Standard: true)
  const autoLoginPref = localStorage.getItem("autoLogin");
  document.getElementById("editAutoLogin").checked = autoLoginPref !== "false";
  const username = currentUser.user_metadata?.username || "";
  const email = currentUser.email || "";
  const createdAt = currentUser.created_at;
  document.getElementById('editUsername').value = username;
  document.getElementById('editEmail').value = email;
  const themePref = localStorage.getItem('theme') || 'light';
  document.getElementById('editTheme').value = themePref;

  const sinceDate = new Date(createdAt);
  const options = {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  };
  const formatted = sinceDate.toLocaleString('de-DE', options);
  let seitDiv = document.getElementById('mitgliedSeit');
  if (!seitDiv) {
    seitDiv = document.createElement('div');
    seitDiv.id = 'mitgliedSeit';
    seitDiv.style.marginTop = '20px';
    seitDiv.style.color = 'var(--text-secondary)';
    document.getElementById('editProfileForm').appendChild(seitDiv);
  }
  seitDiv.innerText = 'Mitglied seit: ' + formatted;

  document.getElementById('editProfileOverlay').style.display = 'flex';
}

function hideEditProfileForm() {
  document.getElementById('editProfileOverlay').style.display = 'none';
}
</script>
<!-- Aktivitätsübersicht Overlay -->
<div class="form-overlay" id="activityOverlay" style="display: none;">
<div class="form-container">
<button class="form-close" onclick="document.getElementById('activityOverlay').style.display='none'">×</button>
<h2 class="form-title">📈 Aktivitätsübersicht</h2>
<div id="datetimeDisplay" style="text-align:center; font-weight:bold; margin-bottom: 20px;"></div>
<div style="text-align: center; margin-top: 10px;">Hmm, da ist offensichtlich ein Fehler passiert?</div>
</div>
</div>
<script>
document.getElementById('activityButton').addEventListener('click', function () {
  document.getElementById('activityOverlay').style.display = 'flex';
});

</script>

<div class="welcome-overlay" id="verifyEmailOverlay" style="display: none;">
  <div class="welcome-box" id="verifyEmailContent">
    <button class="welcome-close" onclick="closeVerifyEmail()">×</button>
    <h2>📧 Hallo <span id="verifyUserName"></span>,</h2>
    <p>Wir haben Ihnen eine E-Mail an <strong id="verifyEmailTarget"></strong> gesendet.<br>
       Bitte bestätigen Sie Ihre Registrierung.</p>
    <button class="btn btn-primary" onclick="switchToCodeEntry()">Code eingeben</button>
  </div>
</div>


<script>

let pendingVerifyEmail = null;

function showVerifyEmailOverlay(username, email) {
  document.getElementById('verifyUserName').textContent = username;
  document.getElementById('verifyEmailTarget').textContent = email;
  pendingVerifyEmail = email;
  document.getElementById('verifyEmailOverlay').style.display = 'flex';
}

function closeVerifyEmail() {
  document.getElementById('verifyEmailOverlay').style.display = 'none';
  pendingVerifyEmail = null;
}

function switchToCodeEntry() {
  // Inhalt im gleichen Overlay austauschen
  const content = document.getElementById('verifyEmailContent');
  content.innerHTML = `
    <button class="welcome-close" onclick="closeVerifyEmail()">×</button>
    <h2>🔑 Code eingeben</h2>
    <p>Wir haben erneut einen 6-stelligen Code an <strong>${pendingVerifyEmail}</strong> gesendet.<br>
       Bitte geben Sie den Code hier ein:</p>
    <input id="verifyOtpCode" class="form-input" type="text" maxlength="6"
           placeholder="Code Eingeben" style="text-align:center; font-size:20px; letter-spacing:5px; margin-top:15px;"/>
    <button class="btn btn-primary" style="margin-top:15px;" onclick="submitVerificationCode()">Absenden</button>
  `;

  // Optional: hier nochmal Supabase triggern, um neuen Code zu senden
  supabaseClient.auth.resend({
    type: 'signup',
    email: pendingVerifyEmail
  }).catch(err => console.error("Fehler beim erneuten Senden des Codes:", err));
}

async function submitVerificationCode() {
  const codeInput = document.getElementById('verifyOtpCode');
  const code = codeInput.value.trim();

  if (code.length !== 6) {
    showNotification("Bitte 6-stelligen Code eingeben", "error");
    return;
  }

  try {
    const { data, error } = await supabaseClient.auth.verifyOtp({
      email: pendingVerifyEmail,
      token: code,
      type: 'signup'
    });

    if (error) {
      showNotification("Code ungültig. Bitte erneut eingeben.", "error");
      codeInput.value = "";
      return;
    }

    currentUser = data.user;
    updateUIForLoggedInUser();
    showNotification("E-Mail erfolgreich verifiziert!", "success");
    closeVerifyEmail();

  } catch (err) {
    console.error(err);
    showNotification("Ein Fehler ist aufgetreten", "error");
  }
}

</script>

<!-- Passwort ändern Formular -->
<div class="form-overlay" id="changePasswordOverlay" style="display: none;">
<div class="form-container">
<button class="form-close" onclick="hideChangePasswordForm()">×</button>
<h2 class="form-title">Passwort ändern</h2>
<form id="changePasswordForm">
<div class="form-group">
<label class="form-label" for="newPassword">Neues Passwort</label>
<input class="form-input" id="newPassword" required="" type="password"/>
</div>
<div class="form-group">
<label class="form-label" for="confirmNewPassword">Neues Passwort bestätigen</label>
<input class="form-input" id="confirmNewPassword" required="" type="password"/>
</div>
<button class="form-submit" type="submit">Passwort ändern</button>
</form>
</div>
</div>
<!-- Hinweis-Popup nach Passwortänderung -->
<div class="welcome-overlay" id="passwordChangedOverlay" style="display: none;">
<div class="welcome-box">
<button class="welcome-close" onclick="closePasswordChangedPopup()">×</button>
<h2>Hallo Nutzer,</h2>
<p>Vielen Dank das sie ihr Passwort geändert haben, um ihre Sicherheit zu stärken, ihr Passwort ist in wenigen Sekunden einsatzbereit vielen Dank für die Nutzung bei uns.</p>
<button class="btn btn-primary" onclick="closePasswordChangedPopup()">Verstanden</button>
</div>
</div>
<script>
function showChangePasswordForm() {
  document.getElementById('changePasswordOverlay').style.display = 'flex';
}
function hideChangePasswordForm() {
  document.getElementById('changePasswordOverlay').style.display = 'none';
}
function showVerifyPasswordChangedPopup() {
  document.getElementById('passwordChangedOverlay').style.display = 'flex';
}
function closePasswordChangedPopup() {
  document.getElementById('passwordChangedOverlay').style.display = 'none';
}
document.getElementById('changePasswordForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmNewPassword').value;
  if (newPassword !== confirmPassword) {
    showNotification("Passwörter stimmen nicht überein", "error");
    return;
  }
  const { error } = await supabaseClient.auth.updateUser({ password: newPassword });
  if (error) {
    showNotification("Fehler beim Ändern des Passworts", "error");
    console.error(error);
  } else {
    hideChangePasswordForm();
    showVerifyPasswordChangedPopup();
  }
});
</script>

<script>
// Check ob der Benutzer eingeloggt ist
function isUserLoggedIn() {
  return currentUser !== null;
}

// Anmelde-Tipp Popup alle 5 Minuten
setInterval(() => {
  if (!isUserLoggedIn()) {
    showLoginReminder();
  }
}, 5 * 60 * 1000);


<!-- SUBMIT-HANDLER FÜR PROFIL SPEICHERN
  const username = document.getElementById('editUsername').value.trim();
  const email = document.getElementById('editEmail').value.trim();

  if (!username || !email) {
    showNotification('Bitte alle Felder ausfüllen', 'error');
    return;
  }

  try {
    const { data, error } = await supabaseClient.auth.updateUser({
      email,
      data: { username }
    });

    if (error) {
      console.error(error);
      showNotification('Fehler beim Aktualisieren des Profils', 'error');
      return;
    }

    hideEditProfileForm();
    showNotification('Profil erfolgreich aktualisiert!', 'success');
  } catch (err) {
    console.error(err);
    showNotification('Unerwarteter Fehler beim Speichern', 'error');
  };
</script>

<style>
/* Optional: Stil-Anpassungen für Popups */
.welcome-box h2 {
  font-size: 22px;
  margin-bottom: 10px;
}
.welcome-box p {
  font-size: 16px;
  line-height: 1.5;
}

/* Discord-ähnlicher Verwarnungspopup */
#warningOverlay .welcome-box {
  max-width: 420px;
  background: var(--bg-primary);
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 12px 28px rgba(0,0,0,0.3);
  color: var(--text-primary);
  text-align: left;
}

#warningOverlay .welcome-box h2 {
  font-size: 20px;
  margin-bottom: 10px;
  color: var(--error-color);
}

#warningOverlay .welcome-box p,
#warningOverlay .welcome-box small {
  font-size: 15px;
  color: var(--text-secondary);
}


#starRating span {
  font-size: 24px;
  cursor: pointer;
  color: #ccc;
}
#starRating span.selected {
  color: gold;
}


/* Glänzender Effekt bei Hover für .btn-primary */
.btn-primary {
  position: relative;
  overflow: hidden;
}
.btn-primary::after {
  content: "";
  position: absolute;
  top: 0;
  left: -75%;
  width: 50%;
  height: 100%;
  background: linear-gradient(120deg, rgba(255,255,255,0.2), rgba(255,255,255,0.6), rgba(255,255,255,0.2));
  transform: skewX(-20deg);
  transition: left 0.5s;
}
.btn-primary:hover::after {
  left: 125%;
}


/* Feature-Karten mit weicher Transformation und Licht-Glow beim Hover */
.feature-card {
  transition: transform 0.4s ease, box-shadow 0.4s ease;
}
.feature-card:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
}

</style>

<script>
// Direkt nach Willkommens-Overlay zeigen wir die Reminder automatisch
function startPopupIntervals() {
  if (!sessionStorage.getItem('loginReminderClosed') && !currentUser) {
    setTimeout(() => {
      showLoginReminder();
    }, 5000);
  }}

function showLoginReminder() {
  if (sessionStorage.getItem('loginReminderClosed')) return;
  const overlay = document.createElement('div');
  overlay.className = 'welcome-overlay';
  overlay.innerHTML = `
    <div class="welcome-box">
      <button class="welcome-close" onclick="this.parentElement.parentElement.remove()">×</button>
      <h2>🔐 Noch nicht angemeldet?</h2>
      <p>Melde dich an, um alle Funktionen der EHE Community zu nutzen!</p>
      <button class="btn btn-primary" onclick="showLoginForm(); closeLoginReminder(this);">Jetzt anmelden</button>
    </div>
  `
  document.body.appendChild(overlay);
};
</script>

<style>
.welcome-box h2 {
  font-size: 22px;
  margin-bottom: 10px;
}
.welcome-box p {
  font-size: 16px;
  line-height: 1.5;
}

/* Discord-ähnlicher Verwarnungspopup */
#warningOverlay .welcome-box {
  max-width: 420px;
  background: var(--bg-primary);
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 12px 28px rgba(0,0,0,0.3);
  color: var(--text-primary);
  text-align: left;
}

#warningOverlay .welcome-box h2 {
  font-size: 20px;
  margin-bottom: 10px;
  color: var(--error-color);
}

#warningOverlay .welcome-box p,
#warningOverlay .welcome-box small {
  font-size: 15px;
  color: var(--text-secondary);
}

#starRating span {
  font-size: 24px;
  cursor: pointer;
  color: #ccc;
}
#starRating span.selected {
  color: gold;
}


/* Glänzender Effekt bei Hover für .btn-primary */
.btn-primary {
  position: relative;
  overflow: hidden;
}
.btn-primary::after {
  content: "";
  position: absolute;
  top: 0;
  left: -75%;
  width: 50%;
  height: 100%;
  background: linear-gradient(120deg, rgba(255,255,255,0.2), rgba(255,255,255,0.6), rgba(255,255,255,0.2));
  transform: skewX(-20deg);
  transition: left 0.5s;
}
.btn-primary:hover::after {
  left: 125%;
}


/* Feature-Karten mit weicher Transformation und Licht-Glow beim Hover */
.feature-card {
  transition: transform 0.4s ease, box-shadow 0.4s ease;
}
.feature-card:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
}

</style>


<script>
document.addEventListener('DOMContentLoaded', async () => {
  const { data: { session } } = await supabaseClient.auth.getSession();
  currentUser = session?.user || null;
  startPopupIntervals();
});

function showLoginReminder() {
  if (sessionStorage.getItem('loginReminderClosed')) return;
  const overlay = document.createElement('div');
  overlay.className = 'welcome-overlay';
  overlay.innerHTML = `
    <div class="welcome-box">
      <button class="welcome-close" onclick="closeLoginReminder(this)">×</button>
      <h2>🔐 Noch nicht angemeldet?</h2>
      <p>Melde dich an, um alle Funktionen der EHE Community zu nutzen!</p>
      <button class="btn btn-primary" onclick="showLoginForm(); closeLoginReminder(this)">Jetzt anmelden</button>
    </div>
  `;
  document.body.appendChild(overlay);
}

function closeLoginReminder(button) {
  const popup = button.closest('.welcome-overlay');
  popup.remove();
  sessionStorage.setItem('loginReminderClosed', 'true');
}

function closeUpdatePopup(button) {
  const popup = button.closest('.welcome-overlay');
  popup.remove();
  sessionStorage.setItem('updatePopupClosed', 'true');
}
</script>


<!-- Verwarnung Popup -->
<div class="welcome-overlay" id="warningOverlay" style="display: none;">
  <div class="welcome-box">
    <button class="welcome-close" onclick="closeWarningPopup()">×</button>
    <h2>⚠️ Verwarnung</h2>
    <p id="warningReason">Grund wird geladen...</p>
    <small id="warningMeta">Ausgestellt von ...</small>
    <br><br>
    <button class="btn btn-primary" onclick="closeWarningPopup()">Verstanden</button>
  </div>
</div>


<script>
// Verwarnung anzeigen
async function checkUserWarnings(userId) {
  const { data, error } = await supabaseClient
    .from('warnings')
    .select('*')
    .eq('user_id', userId)
    .order('created_at', { ascending: false });

  if (error) {
    console.error("Fehler beim Abrufen der Verwarnungen:", error);
    return;
  }

  if (data.length > 0) {
    const lastWarning = data[0];
    showWarningPopup(lastWarning.reason, lastWarning.issued_by, lastWarning.created_at, lastWarning.fall_id);
  }
}

function showWarningPopup(reason, issuedBy, date, fallId) {
  document.getElementById("warningReason").textContent = `Grund: ${reason}`;
  let meta = `Ausgestellt von ${issuedBy} am ${new Date(date).toLocaleString('de-DE')}`;
  if (fallId) {
    meta += ` | Fall-ID: ${fallId}`;
  }
  document.getElementById("warningMeta").textContent = meta;
  document.getElementById("warningOverlay").style.display = "flex";
};
  document.getElementById("warningMeta").textContent = `Ausgestellt von ${issuedBy} am ${new Date(date).toLocaleString('de-DE')}`;
  document.getElementById("warningOverlay").style.display = "flex";

function closeWarningPopup() {
  document.getElementById("warningOverlay").style.display = "none";
}

// Erweiterung bestehender Login-UI-Funktion
const originalUpdateUI = updateUIForLoggedInUser;
updateUIForLoggedInUser = function () {
  originalUpdateUI();
  if (currentUser) {
    if (!sessionStorage.getItem("warningShown")) {
  checkUserWarnings(currentUser.id).then(() => {
    sessionStorage.setItem("warningShown", "true");
  });
}
  }
};
</script>


<!-- Verwarnungen-Overlay -->
<div class="form-overlay" id="warningsOverlay" style="display: none;">
  <div class="form-container">
    <button class="form-close" onclick="document.getElementById('warningsOverlay').style.display='none'">×</button>
    <h2 class="form-title">⚠️ Deine Verwarnungen</h2>
    <div id="warningsList" style="margin-top: 20px;">
      <p>Lade Verwarnungen...</p>
    </div>
  </div>
</div>


<script>
async function showWarnings() {
  document.getElementById("warningsOverlay").style.display = "flex";
  const list = document.getElementById("warningsList");
  list.innerHTML = "<p>Lade Verwarnungen...</p>";

  const { data, error } = await supabaseClient
    .from('warnings')
    .select('*')
    .eq('user_id', currentUser.id)
    .order('created_at', { ascending: false });

  if (error) {
    list.innerHTML = `<p style="color: var(--error-color)">Fehler beim Laden: ${error.message}</p>`;
    return;
  }

  if (!data || data.length === 0) {
    list.innerHTML = "<p>Du hast aktuell keine Verwarnungen 🎉</p>";
    return;
  }

  
list.innerHTML = data.map(warn => `
  <div style="border-bottom: 1px solid var(--border-color); padding: 10px 0;">
    <strong>Grund:</strong> ${warn.reason}<br/>
    <strong>Ausgestellt von:</strong> ${warn.issued_by}<br/>
    <strong>Fall-ID:</strong> ${warn.fall_id || 'Nicht vorhanden'}<br/>
    <small>${new Date(warn.created_at).toLocaleString('de-DE')}</small>
  </div>
`).join("");

}
</script>


<!-- 📛 XP + Badge + Fun Fact System -->
<script>
const funFacts = [
  "💡 Die EHE Community wurde während eines Regensturms geboren.",
  "🎮 Jeden Monat werden über 30.000 Spielminuten gezählt.",
  "🌍 Über 10 Länder sind in der Community vertreten.",
  "🧩 Es gibt mindestens 5 versteckte Easter Eggs auf der Seite!",
  "📅 Unser erster Event war ein spontaner Voice-Chat!"
];

function rewardDailyXP() {
  const today = new Date().toISOString().split('T')[0];
  const lastXPDate = localStorage.getItem('lastXPReward');
  if (lastXPDate === today) return;
  let currentXP = parseInt(localStorage.getItem('userXP') || "0");
  currentXP += 35;
  logXPEvent("Täglicher Login", 35);
  localStorage.setItem('userXP', currentXP);
  localStorage.setItem('lastXPReward', today);
  showNotification(`🎉 35 XP für heutigen Login erhalten!`, "success");
  updateXPDisplay(currentXP);
}

function getBadgeForXP(xp) {
  if (xp >= 1500) return "🟥 Ultra Legende"
  if (xp >= 1000) return "🟥 Legende";
  if (xp >= 600)  return "🟠 Elite";
  if (xp >= 300)  return "🟣 Veteran";
  if (xp >= 150)  return "🔵 Aktives Mitglied";
  return "🟢 Neuling";
}

function updateXPDisplay(xp) {
  const xpEl = document.getElementById("userXP");
  const levelEl = document.getElementById("userLevel");
  const badgeEl = document.getElementById("userBadge");
  const level = Math.floor(xp / 100) + 1;
  const progress = xp % 100;
  if (xpEl) xpEl.textContent = `${progress} / 100`;
  if (levelEl) levelEl.textContent = `${level}`;
  if (badgeEl) badgeEl.textContent = getBadgeForXP(xp);
}

function showDailyFunFact() {
  const shown = sessionStorage.getItem("funFactShownToday");
  if (shown) return;
  const fact = funFacts[Math.floor(Math.random() * funFacts.length)];
  const overlay = document.createElement('div');
  overlay.className = 'welcome-overlay';
  overlay.innerHTML = `
    <div class="welcome-box">
      <button class="welcome-close" onclick="this.parentElement.parentElement.remove()">×</button>
      <h2>🎉 Fun Fact des Tages</h2>
      <p>${fact}</p>
      <button class="btn btn-primary" onclick="this.closest('.welcome-overlay').remove()">Nice!</button>
    </div>
  `;
  document.body.appendChild(overlay);
  sessionStorage.setItem("funFactShownToday", "true");
}

// Call in updateUIForLoggedInUser()
if (typeof updateUIForLoggedInUser_original === "undefined") {
  updateUIForLoggedInUser_original = updateUIForLoggedInUser;
  updateUIForLoggedInUser = function () {
    updateUIForLoggedInUser_original();
    rewardDailyXP();
    showDailyFunFact();
    const xp = parseInt(localStorage.getItem('userXP') || "0");
    updateXPDisplay(xp);
  };
}
</script>


<!-- Discord Popup -->
<div class="form-overlay" id="discordPopup" style="display: none;">
  <div class="form-container" style="max-width: 400px;">
    <button class="form-close" onclick="hideDiscordPopup()">×</button>
    <h2 class="form-title">🎮 Unser Discord-Server</h2>
    <iframe src="https://discord.com/widget?id=1312453916922875936&theme=dark"
            width="100%" height="400"
            allowtransparency="true" frameborder="0"
            sandbox="allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts">
    </iframe>
  </div>
</div>


<script>
function showDiscordPopup() {
  if (!currentUser) {
    showNotification("Bitte melde dich an, um den Discord zu öffnen!", "error");
    return;
  }
  document.getElementById('discordPopup').style.display = 'flex';
}

function hideDiscordPopup() {
  document.getElementById('discordPopup').style.display = 'none';
}
</script>


<!-- Feedback-Formular -->
<div class="form-overlay" id="feedbackOverlay" style="display: none;">
  <div class="form-container">
    <button class="form-close" onclick="hideFeedbackForm()">×</button>
    <h2 class="form-title">⭐ Feedback abgeben</h2>
    <form id="feedbackForm">
      <div class="form-group">
        <label class="form-label">Sterne</label>
        <div id="starRating">
          <span data-stars="1">★</span>
          <span data-stars="2">★</span>
          <span data-stars="3">★</span>
          <span data-stars="4">★</span>
          <span data-stars="5">★</span>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Grund</label>
        <select class="form-input" id="feedbackReason" required>
          <option value="">Wähle einen Grund</option>
          <option value="Allgemein">Allgemeines Feedback</option>
          <option value="Lob">Lob</option>
          <option value="Verbesserung">Verbesserungsvorschlag</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Nachricht (optional)</label>
        <textarea class="form-input" id="feedbackText" rows="4"></textarea>
      </div>
      <button class="form-submit" type="submit">Absenden</button>
    </form>
  </div>
</div>


<!-- Spinner-Loading Popup -->
<div class="welcome-overlay" id="updatesLoading" style="display: none;">
  <div class="welcome-box" style="text-align: center;">
    <div class="loading-spinner" style="width: 60px; height: 60px; border: 6px solid rgba(255,255,255,0.3); border-top: 6px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto;"></div>
    <h2 style="color: var(--text-primary); margin-bottom: 10px;">Bitte warten...</h2>
    <p style="color: var(--text-secondary); font-size: 16px;">Wir laden die Updates für Sie.</p>
  </div>
</div>

<!-- Wartungspopup -->
<div class="welcome-overlay" id="updatesOverlay" style="display: none;">
  <div class="welcome-box">
    <button class="welcome-close" onclick="document.getElementById('updatesOverlay').style.display='none'">×</button>
    <h2>🛠️ Updates in Arbeit</h2>
    <p>Aktuell sind Wartungsarbeiten an diesem System.<br/>Bitte versuchen Sie es später erneut.</p>
  </div>
</div>


<!-- 🎖️ Badge-Overlay mit Beschreibung -->
<div class="form-overlay" id="badgeOverlay" style="display: none;">
  <div class="form-container" style="max-height: 85vh; overflow: hidden; width: 95%; max-width: 600px;">
    <button class="form-close" onclick="hideBadgePopup()">×</button>
    <h2 class="form-title">🎖 Deine erhaltenen Badges</h2>
    <div id="badgeList" class="badge-scroll-box"></div>
  </div>
</div>



<!-- Allgemeines Info-Popup -->
<div class="welcome-overlay" id="cardInfoPopup" style="display: none;">
  <div class="welcome-box">
    <button class="welcome-close" onclick="hideCardPopup()">×</button>
    <h2 id="cardPopupTitle">🔒 Geschützt</h2>
    <p id="cardPopupText">Diese Funktion ist nur für angemeldete Nutzer verfügbar.</p>
    <button class="btn btn-primary" onclick="hideCardPopup()">OK</button>
  </div>
</div>


<script>
function showCardPopup(title, text) {
  document.getElementById("cardPopupTitle").textContent = title;
  document.getElementById("cardPopupText").textContent = text;
  document.getElementById("cardInfoPopup").style.display = "flex";
}

function hideCardPopup() {
  document.getElementById("cardInfoPopup").style.display = "none";
}

function handleCommunityChat() {
  if (!currentUser) {
    showNotification("❗ Nur für angemeldete Nutzer verfügbar: Community Chat", "warning");
    return;
  }
  showCardPopup("💬 Community Chat", "Der Community Chat befindet sich aktuell in der Entwicklung.");
}

function handleGamingEvents() {
  if (!currentUser) {
    showNotification("❗ Nur für angemeldete Nutzer verfügbar: Gaming Events", "warning");
    return;
  }
  showCardPopup("🎮 Gaming Events", "Zurzeit stehen keine aktiven Events an.");
}

function handleAchievements() {
  if (!currentUser) {
    showNotification("❗ Nur für angemeldete Nutzer verfügbar: Achievements", "warning");
    return;
  }
  showCardPopup("🏆 Achievements", "Wir haben derzeit Probleme beim Öffnen der Achievements.");
}
</script>



<footer style="text-align: center; padding: 40px 20px; color: var(--text-secondary); font-size: 14px;">
  <div>© 2025 EHE Community</div>
  <div style="margin-top: 5px;">Entwickelt von <strong style="color: var(--primary-color)">EHE Community Webseite Studio</strong></div>
</footer>


<script>
document.querySelectorAll('.nav-link').forEach(link => {
  link.addEventListener('click', function(e) {
    e.preventDefault();
    const target = this.textContent.trim().toLowerCase();
    let id = {
      home: 'mainContent',
      community: 'features-start',
      events: 'features-start',
      kontakt: 'kontaktbereich'
    }[target];
    if (id && document.getElementById(id)) {
      document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
    }
  });
});
</script>


<!-- Ban-Popup Overlay -->
<div class="welcome-overlay" id="banOverlay" style="display: none;">
  <div class="welcome-box">
    <button class="welcome-close" onclick="closeBanPopup()">×</button>
    <h2>🚫 Dein Konto wurde gesperrt</h2>
    <p><strong>Grund:</strong> Gegen unsere Community Richtlinien verstoßen</p>
    <p><strong>Details:</strong> Dein Verhalten verstößt gegen unsere Regeln. Du wurdest daher temporär oder dauerhaft gesperrt.</p>
    <p><strong>Konto Entsperrt:</strong> Bei Fragen wann ihr Konto entsperrt wird, melden sie sich gerne per Discord oder per E-Mail an uns.</p>
    <p><strong>Entsperrung möglich:</strong> <a href="https://roxyboy179.github.io/ehe_wiederspruch/" target="_blank" style="color: var(--primary-color); font-weight: bold;">Antrag auf Entsperrung stellen</a></p>
    <button class="btn btn-primary" onclick="closeBanPopup()">Verstanden</button>
  </div>
</div>


<!-- Passwort bestätigen (für Profilbearbeitung & Passwortänderung) -->
<div class="form-overlay" id="confirmPasswordOverlay" style="display: none;">
  <div class="form-container">
    <button class="form-close" onclick="hideConfirmPassword()">×</button>
    <h2 class="form-title">🔒 Passwort bestätigen</h2>
    <form id="confirmPasswordForm">
      <div class="form-group">
        <label class="form-label" for="confirmPasswordInput">Bitte gib dein aktuelles Passwort ein</label>
        <input class="form-input" id="confirmPasswordInput" type="password" required />
      </div>
      <button class="form-submit" type="submit">Bestätigen</button>
    </form>
  </div>
</div>


<script>
function showEditProfileFormWithPassword() {
  if (!currentUser) {
    showNotification("Du musst angemeldet sein", "error");
    return;
  }
  sessionStorage.setItem("nextAction", "editProfile");
  document.getElementById("confirmPasswordOverlay").style.display = "flex";
}

function showChangePasswordFormWithPassword() {
  if (!currentUser) {
    showNotification("Du musst angemeldet sein", "error");
    return;
  }
  sessionStorage.setItem("nextAction", "changePassword");
  document.getElementById("confirmPasswordOverlay").style.display = "flex";
}

function hideConfirmPassword() {
  document.getElementById("confirmPasswordOverlay").style.display = "none";
  document.getElementById("confirmPasswordForm").reset();
}

document.getElementById("confirmPasswordForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  const password = document.getElementById("confirmPasswordInput").value;
  try {
    const { data, error } = await supabaseClient.auth.signInWithPassword({
      email: currentUser.email,
      password: password
    });
    if (error) {
      showNotification("Falsches Passwort", "error");
      return;
    }
    hideConfirmPassword();
    const action = sessionStorage.getItem("nextAction");
    sessionStorage.removeItem("nextAction");
    if (action === "editProfile") {
      showEditProfileForm();
    } else if (action === "changePassword") {
      showChangePasswordForm();
    }
  } catch (err) {
    console.error(err);
    showNotification("Fehler bei der Verifizierung", "error");
  }
});
</script>


<script>

function toggleTheme() {
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  applyTheme(newTheme);
}

function applyTheme(theme) {
  currentTheme = theme;
  if (theme === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
  } else {
    document.documentElement.removeAttribute('data-theme');
  }
  localStorage.setItem('theme', theme);
  updateThemeToggleButton();
}

function updateThemeToggleButton() {
  const btn = document.getElementById('themeToggle');
  if (btn) {
    btn.textContent = currentTheme === 'dark' ? '☀️' : '🌙';
  }
}

// Theme beim Laden setzen
document.addEventListener('DOMContentLoaded', () => {
  const savedTheme = localStorage.getItem('theme') || 'light';
  applyTheme(savedTheme);
});
</script>


<script>
// 🚨 Verwarnungen anzeigen im Dropdown (Supabase-Tabelle: 'warnings')
async function checkWarnings() {
  if (!currentUser) return;

  try {
    const { data, error } = await supabaseClient
      .from('warnings')
      .select('*')
      .eq('user_id', currentUser.id);

    const badge = document.createElement('div');
    badge.style.marginTop = '5px';
    badge.style.fontSize = '12px';
    badge.style.fontWeight = 'bold';

    if (error) {
      console.error("Fehler beim Laden der Verwarnungen:", error);
      return;
    }

    if (data && data.length > 0) {
      const latest = data[0];
      badge.innerHTML = `⚠️ <span style="color: var(--error-color);">Verwarnt</span><br><small>Grund: ${latest.reason}<br>Datum: ${new Date(latest.date).toLocaleDateString("de-DE")}</small>`;
    } else {
      badge.innerHTML = `🟢 <span style="color: var(--success-color);">Keine Verwarnung</span>`;
    }

    const dropdown = document.getElementById('userDropdown');
    if (dropdown) dropdown.appendChild(badge);

  } catch (e) {
    console.error("Unbekannter Fehler bei Warnungen:", e);
  }
}

// Beim Login oder UI-Update ausführen
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    if (currentUser) checkWarnings();
  }, 2000);
});
</script>


<script>
// === Inaktivitätserkennung ===
let inactivityTime = 5 * 60 * 1000; // 5 Minuten bis Popup
let logoutTime = 30 * 60 * 1000;    // 30 Minuten bis Logout nach Popup
let warningTimeout, logoutTimeout, countdownInterval;
let countdownSeconds = 1800;

function resetInactivityTimer() {
  clearTimeout(warningTimeout);
  clearTimeout(logoutTimeout);
  clearInterval(countdownInterval);
  document.getElementById('inactivityOverlay')?.remove();

  if (currentUser) {
    warningTimeout = setTimeout(showInactivityWarning, inactivityTime);
  }
}

function showInactivityWarning() {
  countdownSeconds = 1800;

  const overlay = document.createElement('div');
  overlay.id = 'inactivityOverlay';
  overlay.className = 'welcome-overlay';
  overlay.innerHTML = `
    <div class="welcome-box">
      <button class="welcome-close" onclick="cancelLogout()">×</button>
      <h2>⚠️ Inaktivität erkannt</h2>
      <p>Sie werden in Kürze automatisch ausgeloggt, da unser System erkannt hat, dass Sie inaktiv sind.</p>
      <p>Automatische Abmeldung in: <strong id="inactivityCountdown">10:00</strong></p>
      <button class="btn btn-primary" onclick="cancelLogout()">Logout abbrechen</button>
    </div>
  `;
  document.body.appendChild(overlay);

  updateCountdown(); // sofort ersten Wert setzen
  countdownInterval = setInterval(updateCountdown, 1000);

  logoutTimeout = setTimeout(() => {
    document.getElementById('inactivityOverlay')?.remove();
    logout();
  }, logoutTime);
}

function updateCountdown() {
  const el = document.getElementById('inactivityCountdown');
  if (!el) return;

  const minutes = Math.floor(countdownSeconds / 60);
  const seconds = countdownSeconds % 60;
  el.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

  countdownSeconds--;
  if (countdownSeconds <= 0) clearInterval(countdownInterval);
}

function cancelLogout() {
  resetInactivityTimer();
}

// Events zur Aktivitätserkennung
['click', 'mousemove', 'keydown', 'touchstart'].forEach(evt =>
  document.addEventListener(evt, resetInactivityTimer)
);

// Beim Start nur aktivieren, wenn eingeloggt
document.addEventListener('DOMContentLoaded', () => {
  if (currentUser) resetInactivityTimer();
});
</script>



<script>
function checkPasswordStrength(password) {
  const feedback = document.getElementById('passwordStrengthFeedback');
  let strength = 0;
  if (password.length >= 8) strength++;
  if (/[A-Z]/.test(password)) strength++;
  if (/[a-z]/.test(password)) strength++;
  if (/[0-9]/.test(password)) strength++;
  if (/[^A-Za-z0-9]/.test(password)) strength++;

  if (password.toLowerCase().includes("123456") || password.toLowerCase().includes("passwort") || password.toLowerCase().includes("admin")) {
    strength = 0;
  }

  const messages = ["Sehr schwach", "Schwach", "Mittel", "Gut", "Stark", "Sehr stark"];
  const colors = ["#e53e3e", "#ed8936", "#ecc94b", "#68d391", "#48bb78", "#38a169"];
  feedback.textContent = messages[strength];
  feedback.style.color = colors[strength];
}

// Events verbinden
document.addEventListener('DOMContentLoaded', () => {
  const passwordInput = document.getElementById('registerPassword') || document.getElementById('newPassword');
  if (passwordInput) {
    passwordInput.addEventListener('input', () => {
      checkPasswordStrength(passwordInput.value);
    });
  }
});
</script>

<script>
function checkUserSecurity(user) {
  const weakPasswords = ["123456", "password", "passwort", "admin", "12345678"];
  const username = user.user_metadata?.username || "";
  const emailConfirmed = user.email_confirmed_at;
  const password = ""; // Kann aus Sicherheitsgründen nicht clientseitig geprüft werden.

  let warningMessage = "";

  if (!emailConfirmed) {
    warningMessage += "⚠️ Deine E-Mail-Adresse wurde noch nicht bestätigt.\n";
  }
  if (username.length < 3 || /[^a-zA-Z0-9]/.test(username)) {
    warningMessage += "⚠️ Dein Benutzername wirkt unsicher oder ist zu kurz.\n";
  }

  if (warningMessage) {
    alert("🔐 Sicherheitswarnung:\n\n" + warningMessage + "\nBitte behebe diese Probleme, sonst kann dein Profil eingeschränkt werden.");
  }
}
</script>

<!-- Sicherheitswarnungs-Popup -->
<div class="welcome-overlay" id="securityWarningOverlay" style="display: none;">
  <div class="welcome-box" style="border: 2px solid var(--error-color);">
    <button class="welcome-close" onclick="closeSecurityWarning()">×</button>
    <h2>🔐 Sicherheitswarnung</h2>
    <p id="securityWarningMessage">Dein Profil enthält Sicherheitslücken.</p>
    <button class="btn btn-primary" onclick="closeSecurityWarning()">Verstanden</button>
  </div>
</div>


<script>
function checkUserSecurity(user) {
  const username = user.user_metadata?.username || "";
  const emailConfirmed = user.email_confirmed_at;

  let warningMessage = "";

  if (!emailConfirmed) {
    warningMessage += "⚠️ Deine E-Mail-Adresse wurde noch nicht bestätigt.<br>";
  }
  if (username.length < 3 || /[^a-zA-Z0-9]/.test(username)) {
    warningMessage += "⚠️ Dein Benutzername ist zu kurz oder enthält unsichere Zeichen.<br>";
  }

  if (warningMessage) {
    document.getElementById('securityWarningMessage').innerHTML = warningMessage;
    document.getElementById('securityWarningOverlay').style.display = 'flex';
  }
}

function closeSecurityWarning() {
  document.getElementById('securityWarningOverlay').style.display = 'none';
}
</script>


<!-- Sicherheitswarnungs-Popup mit Sound und Warnstufe -->
<div class="welcome-overlay" id="securityWarningOverlay" style="display: none;">
  <div class="welcome-box" style="border: 2px solid var(--error-color);">
    <button class="welcome-close" onclick="closeSecurityWarning()">×</button>
    <h2 class="blinking-warning">🚨 Sicherheitswarnung</h2>
    <p id="securityWarningMessage">Dein Profil enthält Sicherheitslücken.</p>
    <div style="margin: 15px 0;">
      <strong>Warnstufe:</strong> <span id="securityLevel" style="font-weight:bold;">Unbekannt</span>
    </div>
    <button class="btn btn-primary" onclick="closeSecurityWarning()">Verstanden</button>
  </div>
</div>
<audio id="securityWarningSound" src="https://www.myinstants.com/media/sounds/mgs-alert.mp3"></audio>


<script>
function checkUserSecurity(user) {
  const username = user.user_metadata?.username || "";
  const emailConfirmed = user.email_confirmed_at;

  let warningMessage = "";
  let level = 0;

  if (!emailConfirmed) {
    warningMessage += "⚠️ Deine E-Mail-Adresse wurde noch nicht bestätigt.<br>";
    level += 1;
  }
  if (username.length < 3 || /[^a-zA-Z0-9]/.test(username)) {
    warningMessage += "⚠️ Dein Benutzername ist zu kurz oder enthält unsichere Zeichen.<br>";
    level += 1;
  }

  if (warningMessage) {
    const levelText = level >= 2 ? "⚠️ Hoch" : "🔸 Mittel";
    document.getElementById('securityWarningMessage').innerHTML = warningMessage;
    document.getElementById('securityLevel').textContent = levelText;
    document.getElementById('securityWarningOverlay').style.display = 'flex';
    document.getElementById('securityWarningSound').play().catch(() => {});
  }
}

function closeSecurityWarning() {
  document.getElementById('securityWarningOverlay').style.display = 'none';
}
</script>

<!-- Sicherheitsstatus-Overlay -->
<div class="form-overlay" id="securityOverlay" style="display: none;">
  <div class="form-container">
    <button class="form-close" onclick="hideSecurityStatus()">×</button>
    <h2 class="form-title">🛡️ Sicherheitsstatus</h2>
    <p style="margin-top: -10px; color: var(--text-secondary); font-size: 14px;">Hier findest du deinen aktuellen Sicherheitsstatus</p>
    <div style="line-height: 1.8; font-size: 15px; color: var(--text-secondary); margin-top: 20px;">
      <p><strong>📧 E-Mail:</strong> <span id="secEmail">-</span></p>
      <p><strong>✅ E-Mail bestätigt:</strong> <span id="secEmailConfirmed">-</span></p>
      <p><strong>📅 Account erstellt:</strong> <span id="secCreatedAt">-</span></p>
      <p><strong>🕓 Letzter Login:</strong> <span id="secLastLogin">-</span></p>
      <p><strong>🔐 Zwei-Faktor-Authentifizierung:</strong> <span id="sec2FA">Derzeit Nicht verfügbar!</span></p>
    </div>
  </div>
</div>
<div class="form-overlay" id="securityOverlay" style="display: none;">
  <div class="form-container">
    <button class="form-close" onclick="hideSecurityStatus()">×</button>
    <h2 class="form-title">🔐 Sicherheitsstatus</h2>
    <div style="line-height: 1.8;">
      <p><strong>E-Mail:</strong> <span id="secEmail">-</span></p>
      <p><strong>E-Mail bestätigt:</strong> <span id="secEmailConfirmed">-</span></p>
      <p><strong>Account erstellt:</strong> <span id="secCreatedAt">-</span></p>
      <p><strong>Letzter Login:</strong> <span id="secLastLogin">-</span></p>
      <p><strong>2-Faktor Authentifizierung:</strong> <span id="sec2FA">Noch nicht implementiert</span></p>
    </div>
  </div>
</div>

<div class="welcome-overlay" id="supportzeitenOverlay" style="display: none;">
  <div class="welcome-box">
    <button class="welcome-close" onclick="closeSupportzeitenPopup()">×</button>
    <h2>📅 Unsere Supportzeiten</h2>
    <p><strong>Mo-Fr:</strong> 09:00 – 22:00 Uhr<br/>
       <strong>Sa:</strong> 12:00 – 20:00 Uhr<br/>
       <strong>So:</strong> ❌ Support geschlossen</p>
    <hr style="margin: 15px 0;">
    <p><strong>Live-Status:</strong> <span id="supportStatusLive">Wird geladen...</span></p>
    <p><strong>Nächste Öffnung:</strong> <span id="nextOpenTime">–</span></p>
    <p><strong>Nächste Schließung:</strong> <span id="nextCloseTime">–</span></p>
    <p><strong>Nächster geplanter Urlaub:</strong><br><span id="nextVacation">Wird berechnet...</span></p>
  </div>
</div>


<script>
function showSupportzeitenPopup() {
  updateSupportStatusLive();
  document.getElementById("supportzeitenOverlay").style.display = "flex";
}

function closeSupportzeitenPopup() {
  document.getElementById("supportzeitenOverlay").style.display = "none";
}

function updateSupportStatusLive() {
  const now = new Date();
  const tag = now.getDay(); // 0 = So, 1 = Mo, ..., 6 = Sa
  const stunde = now.getHours();

  let status = "❌ Geschlossen";

  if (tag >= 1 && tag <= 5 && stunde >= 9 && stunde < 22) {
    status = "✅ Geöffnet (Mo–Fr)";
  } else if (tag === 6 && stunde >= 12 && stunde < 20) {
    status = "✅ Geöffnet (Sa)";
  } else if (tag === 0) {
    status = "❌ Geschlossen (So)";
  }

  document.getElementById("supportStatusLive").textContent = status;

  // Urlaubslogik (alle 2 Monate + 8 Tage Urlaub)
  const startDate = new Date("2024-01-01T00:00:00");
  const heute = new Date();
  let urlaubsStart = new Date(startDate);

  while (urlaubsStart < heute) {
    urlaubsStart.setMonth(urlaubsStart.getMonth() + 2);
  }

  const urlaubsEnde = new Date(urlaubsStart);
  urlaubsEnde.setDate(urlaubsStart.getDate() + 7);

  const formatter = new Intl.DateTimeFormat('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric' });
  document.getElementById("nextVacation").textContent = `von ${formatter.format(urlaubsStart)} bis ${formatter.format(urlaubsEnde)}`;
}
</script>


<div class="welcome-overlay" id="supportzeitenOverlay" style="display: none;">
  <div class="welcome-box">
    <button class="welcome-close" onclick="closeSupportzeitenPopup()">×</button>
    <h2>📅 Unsere Supportzeiten</h2>
    <p><strong>Mo-Fr:</strong> 09:00 – 22:00 Uhr<br/>
       <strong>Sa:</strong> 12:00 – 20:00 Uhr<br/>
       <strong>So:</strong> ❌ Support geschlossen</p>
    <hr style="margin: 15px 0;">
    <p><strong>Live-Status:</strong> <span id="supportStatusLive">Wird geladen...</span></p>
    <p><strong>Nächste Öffnung:</strong> <span id="nextOpenTime">–</span></p>
    <p><strong>Nächste Schließung:</strong> <span id="nextCloseTime">–</span></p>
    <p><strong>Nächster geplanter Urlaub:</strong><br><span id="nextVacation">Wird berechnet...</span></p>
  </div>
</div>


<script>
function showSupportzeitenPopup() {
  updateSupportStatusLive();
  document.getElementById("supportzeitenOverlay").style.display = "flex";
}

function closeSupportzeitenPopup() {
  document.getElementById("supportzeitenOverlay").style.display = "none";
}

function updateSupportStatusLive() {
  const now = new Date();
  const tag = now.getDay();
  const stunde = now.getHours();
  const minute = now.getMinutes();

  let status = "❌ Geschlossen";
  let nextOpen = "Nicht verfügbar";
  let nextClose = "Nicht verfügbar";

  const timeStr = (h, m = 0) => `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')} Uhr`;

  if (tag >= 1 && tag <= 5) {
    if (stunde < 9) {
      nextOpen = "Heute um 09:00 Uhr";
      nextClose = "Heute um 22:00 Uhr";
    } else if (stunde >= 9 && stunde < 22) {
      status = "✅ Geöffnet (Mo–Fr)";
      nextClose = "Heute um 22:00 Uhr";
      nextOpen = "Morgen um 09:00 Uhr";
    } else {
      nextOpen = "Morgen um 09:00 Uhr";
      nextClose = "Morgen um 22:00 Uhr";
    }
  } else if (tag === 6) {
    if (stunde < 12) {
      nextOpen = "Heute um 12:00 Uhr";
      nextClose = "Heute um 20:00 Uhr";
    } else if (stunde >= 12 && stunde < 20) {
      status = "✅ Geöffnet (Sa)";
      nextClose = "Heute um 20:00 Uhr";
      nextOpen = "Montag um 09:00 Uhr";
    } else {
      nextOpen = "Montag um 09:00 Uhr";
    }
  } else {
    nextOpen = "Montag um 09:00 Uhr";
  }

  document.getElementById("supportStatusLive").textContent = status;
  document.getElementById("nextOpenTime").textContent = nextOpen;
  document.getElementById("nextCloseTime").textContent = nextClose;

  // Urlaubslogik (alle 2 Monate + 8 Tage Urlaub)
  const startDate = new Date("2024-01-01T00:00:00");
  const heute = new Date();
  let urlaubsStart = new Date(startDate);

  while (urlaubsStart < heute) {
    urlaubsStart.setMonth(urlaubsStart.getMonth() + 2);
  }

  const urlaubsEnde = new Date(urlaubsStart);
  urlaubsEnde.setDate(urlaubsStart.getDate() + 7);

  const formatter = new Intl.DateTimeFormat('de-DE', {
    weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric'
  });
  document.getElementById("nextVacation").textContent = `von ${formatter.format(urlaubsStart)} bis ${formatter.format(urlaubsEnde)}`;
}
</script>


<!-- Discord-Beschränkung Popup -->
<div class="welcome-overlay" id="discordBlockedOverlay" style="display: none;">
  <div class="welcome-box">
    <button class="welcome-close" onclick="document.getElementById('discordBlockedOverlay').style.display='none'">×</button>
    <h2>🔒 Hallo <span id="discordBlockUser"></span>,</h2>
    <p>
      Du kannst diese Funktion leider nicht verwenden.<br/>
      Da du dich mit <strong>Discord</strong> angemeldet hast, ist <strong><span id="discordBlockAction"></span></strong> deaktiviert.<br/><br/>
      Die EHE Community Webseite Studio hat diese Funktion bei Discord-Anmeldung eingeschränkt.
    </p>
    <button class="btn btn-primary" onclick="document.getElementById('discordBlockedOverlay').style.display='none'">Verstanden</button>
  </div>
</div>


<!-- Warnhinweis Overlay -->
<div class="welcome-overlay" id="warnHinweisOverlay" style="display:none;">
  <div class="welcome-box">
    <button class="welcome-close" onclick="document.getElementById('warnHinweisOverlay').style.display='none'">×</button>
    <h2>⚠️ Anmelde Hinweis</h2>
    <p>Wenn Sie sich mit Discord, Spotify oder Google anmelden, können Sie kein Passwort oder Profil bearbeiten oder ändern, da EHE Community Webseite Studio diese Funktion eingeschränkt hat, um Anmeldeprobleme zu vermeiden.</p>
    <button class="btn btn-primary" onclick="openWeitereMethoden()">Hinweis gelesen</button>
  </div>
</div>

<!-- Weitere Anmeldemethoden Overlay -->
<div class="welcome-overlay" id="weitereMethodenOverlay" style="display:none;">
  <div class="welcome-box">
    <button class="welcome-close" onclick="document.getElementById('weitereMethodenOverlay').style.display='none'">×</button>
    <h2>🔑 Weitere Anmeldemöglichkeiten</h2>
   
   <hr style="margin:15px 0; border: none; border-top: 1px solid var(--border-color);">
    <button class="btn btn-primary" style="width:100%; display:flex; align-items:center; gap:10px; justify-content:center;" disabled>
      <img src="spotify-icon.png" alt="spotify" style="width:20px; height:20px;">
      Mit Spotify anmelden
    </button>


    <hr style="margin:15px 0; border: none; border-top: 1px solid var(--border-color);">
    <button class="btn btn-primary" style="width:100%; display:flex; align-items:center; gap:10px; justify-content:center;" disabled>
      <img src="google-icon.png" alt="Google" style="width:20px; height:20px;">
      Mit Google anmelden
    </button>
    <hr style="margin:15px 0; border: none; border-top: 1px solid var(--border-color);">
    <p style="font-size:12px; color:var(--text-secondary); margin-top:15px;">ℹ️ Die Google und Spotify Anmeldemethode ist derzeit nicht verfügbar.</p>
  </div>
</div>

<script>
function showWarnHinweis() {
  document.getElementById('warnHinweisOverlay').style.display = 'flex';
}
function openWeitereMethoden() {
  document.getElementById('warnHinweisOverlay').style.display = 'none';
  document.getElementById('weitereMethodenOverlay').style.display = 'flex';
}

function closeLoginReminder(button) {
  const popup = button.closest('.welcome-overlay');
  popup.remove();
  sessionStorage.setItem('loginReminderClosed', 'true');
}
function closeUpdatePopup(button) {
  const popup = button.closest('.welcome-overlay');
  popup.remove();
  sessionStorage.setItem('updatePopupClosed', 'true');
}

function rewardProfileEditXP() {
  const today = new Date().toISOString().split('T')[0];
  const lastEditDate = localStorage.getItem('lastProfileEditXP');

  if (lastEditDate === today) return;

  let currentXP = parseInt(localStorage.getItem('userXP') || "0");
  currentXP += 25;
  logXPEvent("Profil bearbeitet", 25);
  localStorage.setItem('userXP', currentXP);
  localStorage.setItem('lastProfileEditXP', today);
  showNotification("🎯 25 XP für das Aktualisieren deines Profils!", "success");
  updateXPDisplay(currentXP);
}
document.getElementById("editProfileForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const username = document.getElementById('editUsername').value.trim();
  const email = document.getElementById('editEmail').value.trim();

  if (!username || !email) {
    showNotification('Bitte alle Felder ausfüllen', 'error');
    return;
  }

  try {
    const { data, error } = await supabaseClient.auth.updateUser({
      email,
      data: { username }
    });

    if (error) {
      console.error(error);
      showNotification('Fehler beim Aktualisieren des Profils', 'error');
      return;
    }

    hideEditProfileForm();
    showNotification('Profil erfolgreich aktualisiert!', 'success');
    
  const selectedTheme = document.getElementById('editTheme').value;
  localStorage.setItem('theme', selectedTheme);
  sessionStorage.setItem('theme', selectedTheme);
  setTheme(selectedTheme);

    rewardProfileEditXP(); // XP vergeben
  } catch (err) {
    console.error(err);
    showNotification('Unerwarteter Fehler beim Speichern', 'error');
  }
});

// XP Logging & Anzeige
function logXPEvent(message, amount) {
  const log = JSON.parse(localStorage.getItem("xpLog") || "[]");
  const entry = {
    message,
    amount,
    date: new Date().toISOString()
  };
  log.unshift(entry);
  localStorage.setItem("xpLog", JSON.stringify(log));
}

window.showXPLog = showXPLog;
function showXPLog() {
  const container = document.getElementById("xpLogEntries");
  const log = JSON.parse(localStorage.getItem("xpLog") || "[]");

  if (!log.length) {
    container.innerHTML = "<p>Keine XP-Aktivitäten vorhanden.</p>";
  }

  container.innerHTML = log.map(entry => `
    <div style="border-bottom: 1px solid var(--border-color); padding: 10px 0;">
      <strong>${entry.amount} XP:</strong> ${entry.message}<br/>
      <small>${new Date(entry.date).toLocaleString('de-DE')}</small>
    </div>
  `).join("");

  document.getElementById("xpLogOverlay").style.display = "flex";
}
// 🛠️ Diese Funktion zeigt das XP-Log an – auch wenn es leer ist
function showXPLog() {
  const container = document.getElementById("xpLogEntries");
  const log = JSON.parse(localStorage.getItem("xpLog") || "[]");

  if (!container) return;

  let html = "";

  if (!log.length) {
    html = "<p id='noXPMessage' style='text-align:center; color: var(--text-secondary);'>Keine XP-Aktivitäten vorhanden.</p>";
  } else {
    html = log.map(entry => `
      <div style="border-bottom: 1px solid var(--border-color); padding: 10px 0;">
        <strong>${entry.amount} XP:</strong> ${entry.message}<br/>
        <small>${new Date(entry.date).toLocaleString('de-DE')}</small>
      </div>
    `).join("");
  }

  container.innerHTML = html;
  document.getElementById("xpLogOverlay").style.display = "flex";
}

// Stelle sicher, dass die Funktion global verfügbar ist
window.showXPLog = showXPLog;

</script>
<!-- Sicherheitscheck Overlay -->
<div class="form-overlay" id="securityCheckOverlay" style="display: none;">
  <div class="form-container">
    <button class="form-close" onclick="document.getElementById('securityCheckOverlay').style.display='none'">×</button>
    <h2 class="form-title">🔐 Sicherheitscheck</h2>
    <div id="securityCheckResults" style="margin-top: 20px;">
      <p>Prüfe Sicherheitsstatus deines Kontos...</p>
    </div>
  </div>
</div>

<script>
async function showSecurityCheck() {
  document.getElementById("securityCheckOverlay").style.display = "flex";
  const output = document.getElementById("securityCheckResults");
  output.innerHTML = "<p>⏳ Sicherheitsprüfung läuft...</p>";

  const email = currentUser?.email;
  const password = localStorage.getItem("lastPassword") || "";
  const loginTime = sessionStorage.getItem("lastLogin") || "Keine Letzte Anmeldung";
  const ip = await fetch("https://api.ipify.org?format=json").then(res => res.json()).then(data => data.ip).catch(() => "unbekannt");

  let html = `<p><strong>Letzte Anmeldung:</strong> ${loginTime}<br/><strong>IP-Adresse:</strong> ${ip}</p>`;

  if (!email) {
    output.innerHTML = html + "<p style='color: var(--error-color)'>Nicht eingeloggt.</p>";
    return;
  }

  try {
    const hash = await sha1(email.toLowerCase().trim());
    const prefix = hash.substring(0, 5);
    const suffix = hash.substring(5).toUpperCase();
    const res = await fetch(`https://api.pwnedpasswords.com/range/${prefix}`);
    const text = await res.text();

    const found = text.includes(suffix);
    if (found) {
      html += `<p style="color: var(--error-color)">⚠️ Deine E-Mail wurde in einem bekannten Datenleck gefunden.</p>`;
    } else {
      html += `<p style="color: var(--success-color)">✅ Keine Leaks mit deiner E-Mail bekannt.</p>`;
    }

    if (password.length < 8 || /^(123456|password|qwerty|letmein|hallo)$/i.test(password)) {
      html += `<p style='color: var(--warning-color)'>⚠️ Dein Passwort ist möglicherweise zu schwach oder sehr beliebt.</p>`;
    } else {
      html += `<p style='color: var(--success-color)'>🔒 Passwort wirkt ausreichend stark.</p>`;
    }

    output.innerHTML = html;
  } catch (err) {
    console.error(err);
    output.innerHTML = html + "<p style='color: var(--error-color)'>Fehler bei der Sicherheitsprüfung.</p>";
  }
}

async function sha1(str) {
  const buffer = new TextEncoder().encode(str);
  const hashBuffer = await crypto.subtle.digest("SHA-1", buffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, "0")).join("").toUpperCase();
}

document.getElementById('userProfile')?.addEventListener('click', function (e) {
  const dropdown = document.getElementById('userDropdown');
  if (dropdown && !dropdown.querySelector('.dropdown-item.security-check')) {
    const item = document.createElement('div');
    item.className = 'dropdown-item security-check';
    item.textContent = '🔐 Sicherheitscheck';
    item.onclick = showSecurityCheck;
    dropdown.prepend(item);
    }
});

document.addEventListener('DOMContentLoaded', () => {
  if (currentUser) {
    const now = new Date().toLocaleString('de-DE');
    sessionStorage.setItem("lastLogin", now);
  }
});
</script>

<script>
function showBadgePopup() {
  const badgeList = document.getElementById("badgeList");
  const xp = parseInt(localStorage.getItem("userXP") || "0");
  const badges = getUserBadgesWithDescription(xp);

  if (!badges.length) {
    badgeList.innerHTML = `
      <div style="text-align:center; width:100%; padding:20px;">
        <div style="font-size: 30px;">😕</div>
        <div style="margin-top: 10px; font-weight: bold; color: var(--text-secondary);">
          Du hast aktuell noch keine Badges erhalten.
        </div>
      </div>
    `;
  } else {
    badgeList.innerHTML = badges.map(b => `
      <div class="badge">
        <div class="badge-icon">${b.icon}</div>
        <div class="badge-title">${b.name}</div>
        <div class="badge-desc">${b.desc}</div>
      </div>
    `).join("");
  }

  document.getElementById("badgeOverlay").style.display = "flex";
}

function hideBadgePopup() {
  document.getElementById("badgeOverlay").style.display = "none";
}

function getUserBadgesWithDescription(xp) {
  return [
    { icon: "🟢", name: "Neuling", desc: "Du bist neu hier!", minXP: 0 },
    { icon: "🔵", name: "Aktiv", desc: "150 XP erreicht!", minXP: 150 },
    { icon: "🟣", name: "Veteran", desc: "300 XP geschafft!", minXP: 300 },
    { icon: "🟠", name: "Elite", desc: "600 XP verdient!", minXP: 600 },
    { icon: "🟥", name: "Legende", desc: "1000 XP – beeindruckend!", minXP: 1000 },
    { icon: "🟥", name: "Ultra Legende", desc: "1500 XP – absolut top!", minXP: 1500 }
  ].filter(b => xp >= b.minXP);
}

// ESC zum Schließen
document.addEventListener("keydown", function (e) {
  if (e.key === "Escape") hideBadgePopup();
});

// Änderungen im Profil speichern
document.getElementById("editProfileForm").addEventListener("submit", (e) => {
  e.preventDefault();
  const autoLoginChecked = document.getElementById("editAutoLogin").checked;
  localStorage.setItem("autoLogin", autoLoginChecked);
  const selectedTheme = document.getElementById("editTheme").value;
  setTheme(selectedTheme);
  hideEditProfileForm();
  showNotification("Profil gespeichert!", "success");
}); /* Dis Bitte Nicht Entfernen Vieken dank "Behebt den Fehler"*/

</script>
